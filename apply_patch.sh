#!/bin/bash
echo "=== LOOP Platform Patch ==="

if [ ! -d "frontend/src/app/dashboard" ] || [ ! -d "backend/src/modules/tickets" ]; then
  echo "ERROR: Run this from the loop/ directory"
  exit 1
fi

echo 'Patching dashboard page...'
echo 'J3VzZSBjbGllbnQnOwoKaW1wb3J0IHsgdXNlRWZmZWN0LCB1c2VTdGF0ZSB9IGZyb20gJ3JlYWN0JzsKaW1wb3J0IExpbmsgZnJvbSAnbmV4dC9saW5rJzsKaW1wb3J0IHsgYXBpIH0gZnJvbSAnQC9saWIvYXBpJzsKaW1wb3J0IHsgdXNlQXV0aFN0b3JlIH0gZnJvbSAnQC9zdG9yZXMvYXV0aCc7CmltcG9ydCB7IHVzZU5vdGlmaWNhdGlvblN0b3JlIH0gZnJvbSAnQC9zdG9yZXMvbm90aWZpY2F0aW9ucyc7CmltcG9ydCB7CiAgVGlja2V0LCBDbG9jaywgQWxlcnRUcmlhbmdsZSwgQ2hlY2tDaXJjbGUyLCBBcnJvd1VwUmlnaHQsIExvYWRlcjIsCiAgRXllLCBCZWxsLCBCdWlsZGluZzIsIFVzZXIsIFVzZXJDaGVjaywgSW5ib3gsCn0gZnJvbSAnbHVjaWRlLXJlYWN0JzsKCmNvbnN0IHN0YXR1c0NvbG9yczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHsKICBPUEVOOiAnYmctYmx1ZS01MDAvMTAgdGV4dC1ibHVlLTUwMCcsIElOX1BST0dSRVNTOiAnYmctYW1iZXItNTAwLzEwIHRleHQtYW1iZXItNTAwJywKICBXQUlUSU5HX1JFUExZOiAnYmctcHVycGxlLTUwMC8xMCB0ZXh0LXB1cnBsZS01MDAnLCBBUFBST1ZFRDogJ2JnLWVtZXJhbGQtNTAwLzEwIHRleHQtZW1lcmFsZC01MDAnLAogIFJFSkVDVEVEOiAnYmctcmVkLTUwMC8xMCB0ZXh0LXJlZC01MDAnLCBDTE9TRUQ6ICdiZy16aW5jLTUwMC8xMCB0ZXh0LXppbmMtNDAwJywKfTsKY29uc3QgcHJpb3JpdHlDb2xvcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7CiAgTE9XOiAndGV4dC16aW5jLTQwMCcsIE5PUk1BTDogJ3RleHQtYmx1ZS00MDAnLCBISUdIOiAndGV4dC1hbWJlci00MDAnLCBVUkdFTlQ6ICd0ZXh0LXJlZC00MDAnLAp9Owpjb25zdCBwcmlvcml0eURvdHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7CiAgTE9XOiAnYmctemluYy00MDAnLCBOT1JNQUw6ICdiZy1ibHVlLTQwMCcsIEhJR0g6ICdiZy1hbWJlci00MDAnLCBVUkdFTlQ6ICdiZy1yZWQtNDAwJywKfTsKCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBUSUNLRVQgUk9XID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSAqLwpmdW5jdGlvbiBUaWNrZXRSb3coeyB0aWNrZXQsIGhhc1VucmVhZCB9OiB7IHRpY2tldDogYW55OyBoYXNVbnJlYWQ6IGJvb2xlYW4gfSkgewogIHJldHVybiAoCiAgICA8TGluayBocmVmPXtgL2Rhc2hib2FyZC90aWNrZXRzLyR7dGlja2V0LmlkfWB9CiAgICAgIGNsYXNzTmFtZT17YGZsZXggaXRlbXMtY2VudGVyIGdhcC00IHAtNCBweC01IGhvdmVyOmJnLWFjY2VudC81MCB0cmFuc2l0aW9uLWFsbCByZWxhdGl2ZQogICAgICAgICR7aGFzVW5yZWFkID8gJ2JnLXByaW1hcnkvWzAuMDZdIGJvcmRlci1sLVszcHhdIGJvcmRlci1sLXByaW1hcnknIDogJ2JvcmRlci1sLVszcHhdIGJvcmRlci1sLXRyYW5zcGFyZW50J31gfQogICAgPgogICAgICB7aGFzVW5yZWFkID8gKAogICAgICAgIDxkaXYgY2xhc3NOYW1lPSJyZWxhdGl2ZSBzaHJpbmstMCI+CiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0idy0yLjUgaC0yLjUgcm91bmRlZC1mdWxsIGJnLXByaW1hcnkiIC8+CiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYWJzb2x1dGUgaW5zZXQtMCB3LTIuNSBoLTIuNSByb3VuZGVkLWZ1bGwgYmctcHJpbWFyeSBhbmltYXRlLXBpbmcgb3BhY2l0eS00MCIgLz4KICAgICAgICA8L2Rpdj4KICAgICAgKSA6ICgKICAgICAgICA8ZGl2IGNsYXNzTmFtZT17YHctMi41IGgtMi41IHJvdW5kZWQtZnVsbCBzaHJpbmstMCAke3ByaW9yaXR5RG90c1t0aWNrZXQucHJpb3JpdHldIHx8ICdiZy16aW5jLTQwMCd9YH0gLz4KICAgICAgKX0KICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXgtMSBtaW4tdy0wIj4KICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTIgbWItMSI+CiAgICAgICAgICB7aGFzVW5yZWFkICYmICgKICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMSBweC0xLjUgcHktMC41IGJnLXByaW1hcnkvMTUgdGV4dC1wcmltYXJ5IHJvdW5kZWQgdGV4dC1bMTBweF0gZm9udC1zZW1pYm9sZCI+CiAgICAgICAgICAgICAgPEJlbGwgc2l6ZT17MTB9IGNsYXNzTmFtZT0iZmlsbC1wcmltYXJ5IiAvPiBORVcKICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgKX0KICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT0iZm9udC1tb25vIHRleHQteHMgdGV4dC1tdXRlZC1mb3JlZ3JvdW5kIj57dGlja2V0LnRpY2tldE51bWJlcn08L3NwYW4+CiAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2BweC0xLjUgcHktMC41IHJvdW5kZWQgdGV4dC1bMTBweF0gZm9udC1tZWRpdW0gJHtzdGF0dXNDb2xvcnNbdGlja2V0LnN0YXR1c10gfHwgJyd9YH0+e3RpY2tldC5zdGF0dXMucmVwbGFjZSgnXycsICcgJyl9PC9zcGFuPgogICAgICAgIDwvZGl2PgogICAgICAgIDxwIGNsYXNzTmFtZT17YHRleHQtc20gdHJ1bmNhdGUgJHtoYXNVbnJlYWQgPyAnZm9udC1zZW1pYm9sZCB0ZXh0LWZvcmVncm91bmQnIDogJ2ZvbnQtbWVkaXVtJ31gfT57dGlja2V0LnRpdGxlfTwvcD4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3NOYW1lPSJ0ZXh0LXJpZ2h0IHNocmluay0wIj4KICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTEuNSI+CiAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9InctMiBoLTIgcm91bmRlZC1mdWxsIiBzdHlsZT17eyBiYWNrZ3JvdW5kQ29sb3I6IHRpY2tldC5mcm9tRGVwYXJ0bWVudD8uY29sb3IgfX0gLz4KICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT0idGV4dC14cyB0ZXh0LW11dGVkLWZvcmVncm91bmQiPnt0aWNrZXQuZnJvbURlcGFydG1lbnQ/Lm5hbWV9PC9zcGFuPgogICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPSJ0ZXh0LXhzIHRleHQtbXV0ZWQtZm9yZWdyb3VuZCBteC0xIj7ihpI8L3NwYW4+CiAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9InctMiBoLTIgcm91bmRlZC1mdWxsIiBzdHlsZT17eyBiYWNrZ3JvdW5kQ29sb3I6IHRpY2tldC50b0RlcGFydG1lbnQ/LmNvbG9yIH19IC8+CiAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9InRleHQteHMgdGV4dC1tdXRlZC1mb3JlZ3JvdW5kIj57dGlja2V0LnRvRGVwYXJ0bWVudD8ubmFtZX08L3NwYW4+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9MaW5rPgogICk7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBTVEFUUyArIENIQVJUUyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KZnVuY3Rpb24gU3RhdHNSb3coeyBzdGF0cyB9OiB7IHN0YXRzOiB7IGxhYmVsOiBzdHJpbmc7IHZhbHVlOiBudW1iZXI7IGljb246IGFueTsgY29sb3I6IHN0cmluZyB9W10gfSkgewogIHJldHVybiAoCiAgICA8ZGl2IGNsYXNzTmFtZT17YGdyaWQgZ2FwLTRgfSBzdHlsZT17eyBncmlkVGVtcGxhdGVDb2x1bW5zOiBgcmVwZWF0KCR7TWF0aC5taW4oc3RhdHMubGVuZ3RoLCA1KX0sIDFmcilgIH19PgogICAgICB7c3RhdHMubWFwKChzdGF0KSA9PiAoCiAgICAgICAgPGRpdiBrZXk9e3N0YXQubGFiZWx9IGNsYXNzTmFtZT0iYmctY2FyZCBib3JkZXIgYm9yZGVyLWJvcmRlciByb3VuZGVkLTJ4bCBwLTUgaG92ZXI6Ym9yZGVyLXByaW1hcnkvMzAgdHJhbnNpdGlvbi1hbGwiPgogICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXggaXRlbXMtY2VudGVyIGp1c3RpZnktYmV0d2VlbiBtYi0zIj4KICAgICAgICAgICAgPHN0YXQuaWNvbiBjbGFzc05hbWU9e3N0YXQuY29sb3J9IHNpemU9ezIwfSAvPgogICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2B0ZXh0LTJ4bCBmb250LWJvbGQgJHtzdGF0LnZhbHVlID4gMCAmJiBzdGF0LmxhYmVsID09PSAnT3ZlcmR1ZScgPyAndGV4dC1yZWQtNDAwJyA6ICcnfWB9PntzdGF0LnZhbHVlfTwvc3Bhbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPHAgY2xhc3NOYW1lPSJ0ZXh0LXNtIHRleHQtbXV0ZWQtZm9yZWdyb3VuZCI+e3N0YXQubGFiZWx9PC9wPgogICAgICAgIDwvZGl2PgogICAgICApKX0KICAgIDwvZGl2PgogICk7Cn0KCmZ1bmN0aW9uIENoYXJ0c1Jvdyh7IGJ5U3RhdHVzLCBieVByaW9yaXR5IH06IHsgYnlTdGF0dXM6IGFueVtdOyBieVByaW9yaXR5OiBhbnlbXSB9KSB7CiAgcmV0dXJuICgKICAgIDxkaXYgY2xhc3NOYW1lPSJncmlkIGdyaWQtY29scy0xIGxnOmdyaWQtY29scy0yIGdhcC00Ij4KICAgICAgPGRpdiBjbGFzc05hbWU9ImJnLWNhcmQgYm9yZGVyIGJvcmRlci1ib3JkZXIgcm91bmRlZC0yeGwgcC01Ij4KICAgICAgICA8aDMgY2xhc3NOYW1lPSJ0ZXh0LXNtIGZvbnQtc2VtaWJvbGQgbWItNCI+QnkgU3RhdHVzPC9oMz4KICAgICAgICA8ZGl2IGNsYXNzTmFtZT0ic3BhY2UteS0zIj4KICAgICAgICAgIHtieVN0YXR1cz8ubWFwKChzOiBhbnkpID0+IHsKICAgICAgICAgICAgY29uc3QgdG90YWwgPSBieVN0YXR1cy5yZWR1Y2UoKHN1bTogbnVtYmVyLCB4OiBhbnkpID0+IHN1bSArIHguX2NvdW50LCAwKSB8fCAxOwogICAgICAgICAgICByZXR1cm4gKAogICAgICAgICAgICAgIDxkaXYga2V5PXtzLnN0YXR1c30gY2xhc3NOYW1lPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMyI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2BweC0yIHB5LTAuNSByb3VuZGVkLW1kIHRleHQteHMgZm9udC1tZWRpdW0gdy0yOCB0ZXh0LWNlbnRlciAke3N0YXR1c0NvbG9yc1tzLnN0YXR1c10gfHwgJyd9YH0+e3Muc3RhdHVzLnJlcGxhY2UoJ18nLCAnICcpfTwvc3Bhbj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJmbGV4LTEgaC0yIGJnLXNlY29uZGFyeSByb3VuZGVkLWZ1bGwgb3ZlcmZsb3ctaGlkZGVuIj4KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImgtZnVsbCBiZy1wcmltYXJ5LzYwIHJvdW5kZWQtZnVsbCB0cmFuc2l0aW9uLWFsbCIgc3R5bGU9e3sgd2lkdGg6IGAke01hdGgubWF4KDUsIChzLl9jb3VudCAvIHRvdGFsKSAqIDEwMCl9JWAgfX0gLz4KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPSJ0ZXh0LXNtIGZvbnQtbW9ubyB0ZXh0LW11dGVkLWZvcmVncm91bmQgdy04IHRleHQtcmlnaHQiPntzLl9jb3VudH08L3NwYW4+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICk7CiAgICAgICAgICB9KX0KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgY2xhc3NOYW1lPSJiZy1jYXJkIGJvcmRlciBib3JkZXItYm9yZGVyIHJvdW5kZWQtMnhsIHAtNSI+CiAgICAgICAgPGgzIGNsYXNzTmFtZT0idGV4dC1zbSBmb250LXNlbWlib2xkIG1iLTQiPkJ5IFByaW9yaXR5PC9oMz4KICAgICAgICA8ZGl2IGNsYXNzTmFtZT0ic3BhY2UteS0zIj4KICAgICAgICAgIHtieVByaW9yaXR5Py5tYXAoKHA6IGFueSkgPT4gewogICAgICAgICAgICBjb25zdCB0b3RhbCA9IGJ5UHJpb3JpdHkucmVkdWNlKChzdW06IG51bWJlciwgeDogYW55KSA9PiBzdW0gKyB4Ll9jb3VudCwgMCkgfHwgMTsKICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICA8ZGl2IGtleT17cC5wcmlvcml0eX0gY2xhc3NOYW1lPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMyI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9e2B0ZXh0LXhzIGZvbnQtbWVkaXVtIHctMTYgJHtwcmlvcml0eUNvbG9yc1twLnByaW9yaXR5XSB8fCAnJ31gfT57cC5wcmlvcml0eX08L3NwYW4+CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleC0xIGgtMiBiZy1zZWNvbmRhcnkgcm91bmRlZC1mdWxsIG92ZXJmbG93LWhpZGRlbiI+CiAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJoLWZ1bGwgYmctcHJpbWFyeS82MCByb3VuZGVkLWZ1bGwgdHJhbnNpdGlvbi1hbGwiIHN0eWxlPXt7IHdpZHRoOiBgJHtNYXRoLm1heCg1LCAocC5fY291bnQgLyB0b3RhbCkgKiAxMDApfSVgIH19IC8+CiAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT0idGV4dC1zbSBmb250LW1vbm8gdGV4dC1tdXRlZC1mb3JlZ3JvdW5kIHctOCB0ZXh0LXJpZ2h0Ij57cC5fY291bnR9PC9zcGFuPgogICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICApOwogICAgICAgICAgfSl9CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgKTsKfQoKZnVuY3Rpb24gUmVjZW50VGlja2V0cyh7IHRpY2tldHMsIHVucmVhZFRpY2tldElkcyB9OiB7IHRpY2tldHM6IGFueVtdOyB1bnJlYWRUaWNrZXRJZHM6IHN0cmluZ1tdIH0pIHsKICByZXR1cm4gKAogICAgPGRpdiBjbGFzc05hbWU9ImJnLWNhcmQgYm9yZGVyIGJvcmRlci1ib3JkZXIgcm91bmRlZC0yeGwiPgogICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIganVzdGlmeS1iZXR3ZWVuIHAtNSBwYi0wIj4KICAgICAgICA8aDMgY2xhc3NOYW1lPSJ0ZXh0LXNtIGZvbnQtc2VtaWJvbGQiPlJlY2VudGx5IFVwZGF0ZWQ8L2gzPgogICAgICAgIDxMaW5rIGhyZWY9Ii9kYXNoYm9hcmQvdGlja2V0cyIgY2xhc3NOYW1lPSJ0ZXh0LXhzIHRleHQtcHJpbWFyeSBob3Zlcjp1bmRlcmxpbmUgZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTEiPgogICAgICAgICAgVmlldyBhbGwgPEFycm93VXBSaWdodCBzaXplPXsxMn0gLz4KICAgICAgICA8L0xpbms+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2IGNsYXNzTmFtZT0iZGl2aWRlLXkgZGl2aWRlLWJvcmRlciI+CiAgICAgICAge3RpY2tldHM/Lm1hcCgodGlja2V0OiBhbnkpID0+ICgKICAgICAgICAgIDxUaWNrZXRSb3cga2V5PXt0aWNrZXQuaWR9IHRpY2tldD17dGlja2V0fSBoYXNVbnJlYWQ9e3VucmVhZFRpY2tldElkcy5pbmNsdWRlcyh0aWNrZXQuaWQpfSAvPgogICAgICAgICkpfQogICAgICAgIHsoIXRpY2tldHM/Lmxlbmd0aCkgJiYgKAogICAgICAgICAgPHAgY2xhc3NOYW1lPSJwLTggdGV4dC1jZW50ZXIgdGV4dC1zbSB0ZXh0LW11dGVkLWZvcmVncm91bmQiPk5vIHRpY2tldHMgeWV0PC9wPgogICAgICAgICl9CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgKTsKfQoKLyogPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09IE1BSU4gUEFHRSA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT0gKi8KZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gRGFzaGJvYXJkUGFnZSgpIHsKICBjb25zdCB7IHVzZXIgfSA9IHVzZUF1dGhTdG9yZSgpOwogIGNvbnN0IFtkYXRhLCBzZXREYXRhXSA9IHVzZVN0YXRlPGFueT4obnVsbCk7CiAgY29uc3QgW2xvYWRpbmcsIHNldExvYWRpbmddID0gdXNlU3RhdGUodHJ1ZSk7CiAgY29uc3QgW3ZpZXcsIHNldFZpZXddID0gdXNlU3RhdGU8J3BlcnNvbmFsJyB8ICdkZXBhcnRtZW50Jz4oJ3BlcnNvbmFsJyk7CiAgY29uc3QgeyB1bnJlYWRUaWNrZXRJZHMsIGZldGNoVW5yZWFkVGlja2V0SWRzIH0gPSB1c2VOb3RpZmljYXRpb25TdG9yZSgpOwoKICB1c2VFZmZlY3QoKCkgPT4gewogICAgYXBpLmdldERhc2hib2FyZCgpLnRoZW4oc2V0RGF0YSkuZmluYWxseSgoKSA9PiBzZXRMb2FkaW5nKGZhbHNlKSk7CiAgICBmZXRjaFVucmVhZFRpY2tldElkcygpOwogIH0sIFtdKTsKCiAgaWYgKGxvYWRpbmcpIHJldHVybiA8ZGl2IGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIganVzdGlmeS1jZW50ZXIgaC02NCI+PExvYWRlcjIgY2xhc3NOYW1lPSJhbmltYXRlLXNwaW4gdGV4dC1wcmltYXJ5IiBzaXplPXsyNH0gLz48L2Rpdj47CgogIGNvbnN0IGhhc0RlcHRWaWV3ID0gZGF0YT8uaXNEZXB0SGVhZCAmJiBkYXRhPy5kZXBhcnRtZW50OwogIGNvbnN0IHAgPSBkYXRhPy5wZXJzb25hbCB8fCB7fTsKICBjb25zdCBkID0gZGF0YT8uZGVwYXJ0bWVudCB8fCB7fTsKCiAgcmV0dXJuICgKICAgIDxkaXYgY2xhc3NOYW1lPSJzcGFjZS15LTYiPgogICAgICB7LyogSGVhZGVyICovfQogICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIganVzdGlmeS1iZXR3ZWVuIj4KICAgICAgICA8ZGl2PgogICAgICAgICAgPGgxIGNsYXNzTmFtZT0idGV4dC0yeGwgZm9udC1ib2xkIj5XZWxjb21lIGJhY2ssIHt1c2VyPy5maXJzdE5hbWV9PC9oMT4KICAgICAgICAgIDxwIGNsYXNzTmFtZT0idGV4dC1tdXRlZC1mb3JlZ3JvdW5kIHRleHQtc20gbXQtMSI+SGVyZSdzIHdoYXQncyBoYXBwZW5pbmcgaW4geW91ciB3b3Jrc3BhY2U8L3A+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgoKICAgICAgey8qIFZpZXcgdG9nZ2xlIOKAlCBvbmx5IGZvciBkZXB0IGhlYWRzICovfQogICAgICB7aGFzRGVwdFZpZXcgJiYgKAogICAgICAgIDxkaXYgY2xhc3NOYW1lPSJmbGV4IGdhcC0xIGJnLXNlY29uZGFyeSByb3VuZGVkLXhsIHAtMSB3LWZpdCI+CiAgICAgICAgICA8YnV0dG9uCiAgICAgICAgICAgIG9uQ2xpY2s9eygpID0+IHNldFZpZXcoJ3BlcnNvbmFsJyl9CiAgICAgICAgICAgIGNsYXNzTmFtZT17YGZsZXggaXRlbXMtY2VudGVyIGdhcC0yIHB4LTQgcHktMiByb3VuZGVkLWxnIHRleHQtc20gZm9udC1tZWRpdW0gdHJhbnNpdGlvbi1hbGwgJHsKICAgICAgICAgICAgICB2aWV3ID09PSAncGVyc29uYWwnID8gJ2JnLWNhcmQgc2hhZG93IHRleHQtZm9yZWdyb3VuZCcgOiAndGV4dC1tdXRlZC1mb3JlZ3JvdW5kIGhvdmVyOnRleHQtZm9yZWdyb3VuZCcKICAgICAgICAgICAgfWB9CiAgICAgICAgICA+CiAgICAgICAgICAgIDxVc2VyIHNpemU9ezE1fSAvPiBNeSBUaWNrZXRzCiAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDxidXR0b24KICAgICAgICAgICAgb25DbGljaz17KCkgPT4gc2V0VmlldygnZGVwYXJ0bWVudCcpfQogICAgICAgICAgICBjbGFzc05hbWU9e2BmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMiBweC00IHB5LTIgcm91bmRlZC1sZyB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRyYW5zaXRpb24tYWxsICR7CiAgICAgICAgICAgICAgdmlldyA9PT0gJ2RlcGFydG1lbnQnID8gJ2JnLWNhcmQgc2hhZG93IHRleHQtZm9yZWdyb3VuZCcgOiAndGV4dC1tdXRlZC1mb3JlZ3JvdW5kIGhvdmVyOnRleHQtZm9yZWdyb3VuZCcKICAgICAgICAgICAgfWB9CiAgICAgICAgICA+CiAgICAgICAgICAgIDxCdWlsZGluZzIgc2l6ZT17MTV9IC8+IERlcGFydG1lbnQKICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgIDwvZGl2PgogICAgICApfQoKICAgICAgey8qID09PT09PT09PT09PT0gUEVSU09OQUwgVklFVyA9PT09PT09PT09PT09ICovfQogICAgICB7dmlldyA9PT0gJ3BlcnNvbmFsJyAmJiAoCiAgICAgICAgPD4KICAgICAgICAgIDxTdGF0c1JvdyBzdGF0cz17WwogICAgICAgICAgICB7IGxhYmVsOiAnTXkgT3BlbiBUaWNrZXRzJywgdmFsdWU6IHAubXlPcGVuIHx8IDAsIGljb246IFRpY2tldCwgY29sb3I6ICd0ZXh0LWJsdWUtNDAwJyB9LAogICAgICAgICAgICB7IGxhYmVsOiAnQXNzaWduZWQgdG8gTWUnLCB2YWx1ZTogcC5hc3NpZ25lZFRvTWUgfHwgMCwgaWNvbjogVXNlckNoZWNrLCBjb2xvcjogJ3RleHQtYW1iZXItNDAwJyB9LAogICAgICAgICAgICB7IGxhYmVsOiAnV2F0Y2hpbmcnLCB2YWx1ZTogcC53YXRjaGluZ0NvdW50IHx8IDAsIGljb246IEV5ZSwgY29sb3I6ICd0ZXh0LXB1cnBsZS00MDAnIH0sCiAgICAgICAgICAgIHsgbGFiZWw6ICdPdmVyZHVlJywgdmFsdWU6IHAub3ZlcmR1ZUNvdW50IHx8IDAsIGljb246IEFsZXJ0VHJpYW5nbGUsIGNvbG9yOiAndGV4dC1yZWQtNDAwJyB9LAogICAgICAgICAgXX0gLz4KICAgICAgICAgIDxDaGFydHNSb3cgYnlTdGF0dXM9e3AuYnlTdGF0dXMgfHwgW119IGJ5UHJpb3JpdHk9e3AuYnlQcmlvcml0eSB8fCBbXX0gLz4KICAgICAgICAgIDxSZWNlbnRUaWNrZXRzIHRpY2tldHM9e3AucmVjZW50bHlVcGRhdGVkIHx8IFtdfSB1bnJlYWRUaWNrZXRJZHM9e3VucmVhZFRpY2tldElkc30gLz4KICAgICAgICA8Lz4KICAgICAgKX0KCiAgICAgIHsvKiA9PT09PT09PT09PT09IERFUEFSVE1FTlQgVklFVyA9PT09PT09PT09PT09ICovfQogICAgICB7dmlldyA9PT0gJ2RlcGFydG1lbnQnICYmIGhhc0RlcHRWaWV3ICYmICgKICAgICAgICA8PgogICAgICAgICAgPFN0YXRzUm93IHN0YXRzPXtbCiAgICAgICAgICAgIHsgbGFiZWw6ICdPcGVuIFRpY2tldHMnLCB2YWx1ZTogZC5vcGVuVGlja2V0cyB8fCAwLCBpY29uOiBUaWNrZXQsIGNvbG9yOiAndGV4dC1ibHVlLTQwMCcgfSwKICAgICAgICAgICAgeyBsYWJlbDogJ1dhaXRpbmcgUmVwbHknLCB2YWx1ZTogZC53YWl0aW5nUmVwbHkgfHwgMCwgaWNvbjogQ2xvY2ssIGNvbG9yOiAndGV4dC1hbWJlci00MDAnIH0sCiAgICAgICAgICAgIHsgbGFiZWw6ICdVbmFzc2lnbmVkJywgdmFsdWU6IGQudW5hc3NpZ25lZCB8fCAwLCBpY29uOiBJbmJveCwgY29sb3I6ICd0ZXh0LW9yYW5nZS00MDAnIH0sCiAgICAgICAgICAgIHsgbGFiZWw6ICdUb3RhbCBUaWNrZXRzJywgdmFsdWU6IGQudG90YWxUaWNrZXRzIHx8IDAsIGljb246IENoZWNrQ2lyY2xlMiwgY29sb3I6ICd0ZXh0LWVtZXJhbGQtNDAwJyB9LAogICAgICAgICAgICB7IGxhYmVsOiAnT3ZlcmR1ZScsIHZhbHVlOiBkLm92ZXJkdWVDb3VudCB8fCAwLCBpY29uOiBBbGVydFRyaWFuZ2xlLCBjb2xvcjogJ3RleHQtcmVkLTQwMCcgfSwKICAgICAgICAgIF19IC8+CiAgICAgICAgICA8Q2hhcnRzUm93IGJ5U3RhdHVzPXtkLmJ5U3RhdHVzIHx8IFtdfSBieVByaW9yaXR5PXtkLmJ5UHJpb3JpdHkgfHwgW119IC8+CiAgICAgICAgICA8UmVjZW50VGlja2V0cyB0aWNrZXRzPXtkLnJlY2VudGx5VXBkYXRlZCB8fCBbXX0gdW5yZWFkVGlja2V0SWRzPXt1bnJlYWRUaWNrZXRJZHN9IC8+CiAgICAgICAgPC8+CiAgICAgICl9CiAgICA8L2Rpdj4KICApOwp9Cg==' | base64 -d > frontend/src/app/dashboard/page.tsx
echo 'Patching tickets page...'
echo 'J3VzZSBjbGllbnQnOwoKaW1wb3J0IHsgdXNlRWZmZWN0LCB1c2VTdGF0ZSwgdXNlQ2FsbGJhY2sgfSBmcm9tICdyZWFjdCc7CmltcG9ydCBMaW5rIGZyb20gJ25leHQvbGluayc7CmltcG9ydCB7IHVzZVNlYXJjaFBhcmFtcyB9IGZyb20gJ25leHQvbmF2aWdhdGlvbic7CmltcG9ydCB7IGFwaSB9IGZyb20gJ0AvbGliL2FwaSc7CmltcG9ydCB7IHVzZUF1dGhTdG9yZSB9IGZyb20gJ0Avc3RvcmVzL2F1dGgnOwppbXBvcnQgeyB1c2VOb3RpZmljYXRpb25TdG9yZSB9IGZyb20gJ0Avc3RvcmVzL25vdGlmaWNhdGlvbnMnOwppbXBvcnQgeyBQbHVzLCBMb2FkZXIyLCBDaGV2cm9uTGVmdCwgQ2hldnJvblJpZ2h0LCBDbG9jaywgQWxlcnRUcmlhbmdsZSwgQmVsbCwgWCwgVXNlciwgQnVpbGRpbmcyLCBQZW5TcXVhcmUgfSBmcm9tICdsdWNpZGUtcmVhY3QnOwppbXBvcnQgUmljaFRleHRFZGl0b3IgZnJvbSAnQC9jb21wb25lbnRzL2NvbW1vbi9SaWNoVGV4dEVkaXRvcic7CmltcG9ydCBGaWxlQXR0YWNobWVudCwgeyB0eXBlIFVwbG9hZGVkRmlsZSB9IGZyb20gJ0AvY29tcG9uZW50cy9jb21tb24vRmlsZUF0dGFjaG1lbnQnOwppbXBvcnQgRW50aXR5VHlwZVNlbGVjdG9yIGZyb20gJ0AvY29tcG9uZW50cy9jb21tb24vRW50aXR5VHlwZVNlbGVjdG9yJzsKCmNvbnN0IHN0YXR1c0NvbG9yczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHsKICBEUkFGVDogJ2JnLXppbmMtNTAwLzEwIHRleHQtemluYy01MDAgYm9yZGVyLXppbmMtNTAwLzIwJywKICBPUEVOOiAnYmctYmx1ZS01MDAvMTAgdGV4dC1ibHVlLTUwMCBib3JkZXItYmx1ZS01MDAvMjAnLCBJTl9QUk9HUkVTUzogJ2JnLWFtYmVyLTUwMC8xMCB0ZXh0LWFtYmVyLTUwMCBib3JkZXItYW1iZXItNTAwLzIwJywKICBXQUlUSU5HX1JFUExZOiAnYmctcHVycGxlLTUwMC8xMCB0ZXh0LXB1cnBsZS01MDAgYm9yZGVyLXB1cnBsZS01MDAvMjAnLCBBUFBST1ZFRDogJ2JnLWVtZXJhbGQtNTAwLzEwIHRleHQtZW1lcmFsZC01MDAgYm9yZGVyLWVtZXJhbGQtNTAwLzIwJywKICBSRUpFQ1RFRDogJ2JnLXJlZC01MDAvMTAgdGV4dC1yZWQtNTAwIGJvcmRlci1yZWQtNTAwLzIwJywgQ0xPU0VEOiAnYmctemluYy01MDAvMTAgdGV4dC16aW5jLTQwMCBib3JkZXItemluYy01MDAvMjAnLAp9Owpjb25zdCBwcmlvcml0eURvdHM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7IExPVzogJ2JnLXppbmMtNDAwJywgTk9STUFMOiAnYmctYmx1ZS00MDAnLCBISUdIOiAnYmctYW1iZXItNDAwJywgVVJHRU5UOiAnYmctcmVkLTQwMCcgfTsKCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBDUkVBVEUgTU9EQUwgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCmZ1bmN0aW9uIENyZWF0ZVRpY2tldE1vZGFsKHsgb3Blbiwgb25DbG9zZSwgb25DcmVhdGVkIH06IHsgb3BlbjogYm9vbGVhbjsgb25DbG9zZTogKCkgPT4gdm9pZDsgb25DcmVhdGVkOiAoKSA9PiB2b2lkIH0pIHsKICBjb25zdCB7IHVzZXIgfSA9IHVzZUF1dGhTdG9yZSgpOwogIGNvbnN0IFtkZXBhcnRtZW50cywgc2V0RGVwYXJ0bWVudHNdID0gdXNlU3RhdGU8YW55W10+KFtdKTsKICBjb25zdCBbY2F0ZWdvcmllcywgc2V0Q2F0ZWdvcmllc10gPSB1c2VTdGF0ZTxhbnlbXT4oW10pOwogIGNvbnN0IFt1c2Vycywgc2V0VXNlcnNdID0gdXNlU3RhdGU8YW55W10+KFtdKTsKICBjb25zdCBbZm9ybSwgc2V0Rm9ybV0gPSB1c2VTdGF0ZSh7CiAgICB0aXRsZTogJycsIGRlc2NyaXB0aW9uOiAnJywgdG9EZXBhcnRtZW50SWQ6ICcnLCBzdWJ0eXBlSWQ6ICcnLAogICAgYXNzaWduZWRUb0lkOiAnJywgcHJpb3JpdHk6ICdOT1JNQUwnLCBkdWVEYXRlOiAnJywgZm9ybURhdGE6IHt9IGFzIGFueSwKICAgIGVudGl0eVR5cGU6ICcnIGFzIHN0cmluZywgZW50aXR5SWQ6ICcnIGFzIHN0cmluZywgZW50aXR5TmFtZTogJycgYXMgc3RyaW5nLAogIH0pOwogIGNvbnN0IFthdHRhY2htZW50cywgc2V0QXR0YWNobWVudHNdID0gdXNlU3RhdGU8VXBsb2FkZWRGaWxlW10+KFtdKTsKICBjb25zdCBbY2NVc2VySWRzLCBzZXRDY1VzZXJJZHNdID0gdXNlU3RhdGU8c3RyaW5nW10+KFtdKTsKICBjb25zdCBbc2VsZWN0ZWRTdWJ0eXBlLCBzZXRTZWxlY3RlZFN1YnR5cGVdID0gdXNlU3RhdGU8YW55PihudWxsKTsKICBjb25zdCBbbG9hZGluZywgc2V0TG9hZGluZ10gPSB1c2VTdGF0ZShmYWxzZSk7CiAgY29uc3QgW2Vycm9yLCBzZXRFcnJvcl0gPSB1c2VTdGF0ZSgnJyk7CgogIHVzZUVmZmVjdCgoKSA9PiB7CiAgICBpZiAob3BlbikgewogICAgICBhcGkuZ2V0RGVwYXJ0bWVudHMoKS50aGVuKHNldERlcGFydG1lbnRzKTsKICAgICAgYXBpLmdldFVzZXJzKCkudGhlbigocikgPT4gc2V0VXNlcnMoci5kYXRhKSk7CiAgICAgIHNldEZvcm0oeyB0aXRsZTogJycsIGRlc2NyaXB0aW9uOiAnJywgdG9EZXBhcnRtZW50SWQ6ICcnLCBzdWJ0eXBlSWQ6ICcnLCBhc3NpZ25lZFRvSWQ6ICcnLCBwcmlvcml0eTogJ05PUk1BTCcsIGR1ZURhdGU6ICcnLCBmb3JtRGF0YToge30sIGVudGl0eVR5cGU6ICcnLCBlbnRpdHlJZDogJycsIGVudGl0eU5hbWU6ICcnIH0pOwogICAgICBzZXRBdHRhY2htZW50cyhbXSk7CiAgICAgIHNldENjVXNlcklkcyhbXSk7CiAgICAgIHNldFNlbGVjdGVkU3VidHlwZShudWxsKTsKICAgICAgc2V0RXJyb3IoJycpOwogICAgfQogIH0sIFtvcGVuXSk7CgogIHVzZUVmZmVjdCgoKSA9PiB7CiAgICBpZiAoZm9ybS50b0RlcGFydG1lbnRJZCkgewogICAgICBhcGkuZ2V0Rm9ybUhpZXJhcmNoeShmb3JtLnRvRGVwYXJ0bWVudElkKS50aGVuKHNldENhdGVnb3JpZXMpLmNhdGNoKCgpID0+IHNldENhdGVnb3JpZXMoW10pKTsKICAgIH0gZWxzZSB7IHNldENhdGVnb3JpZXMoW10pOyB9CiAgfSwgW2Zvcm0udG9EZXBhcnRtZW50SWRdKTsKCiAgdXNlRWZmZWN0KCgpID0+IHsKICAgIGlmIChmb3JtLnN1YnR5cGVJZCkgewogICAgICBhcGkuZ2V0U3VidHlwZShmb3JtLnN1YnR5cGVJZCkudGhlbihzZXRTZWxlY3RlZFN1YnR5cGUpLmNhdGNoKCgpID0+IHNldFNlbGVjdGVkU3VidHlwZShudWxsKSk7CiAgICB9IGVsc2UgeyBzZXRTZWxlY3RlZFN1YnR5cGUobnVsbCk7IH0KICB9LCBbZm9ybS5zdWJ0eXBlSWRdKTsKCiAgY29uc3QgZG9TdWJtaXQgPSBhc3luYyAoaXNEcmFmdDogYm9vbGVhbikgPT4gewogICAgc2V0TG9hZGluZyh0cnVlKTsgc2V0RXJyb3IoJycpOwogICAgdHJ5IHsKICAgICAgY29uc3Qgc3VibWl0Rm9ybURhdGEgPSB7IC4uLmZvcm0uZm9ybURhdGEgfTsKICAgICAgaWYgKGZvcm0uZW50aXR5VHlwZSAmJiBmb3JtLmVudGl0eVR5cGUgIT09ICdub25lJykgewogICAgICAgIHN1Ym1pdEZvcm1EYXRhLl9lbnRpdHlUeXBlID0gZm9ybS5lbnRpdHlUeXBlOwogICAgICAgIHN1Ym1pdEZvcm1EYXRhLl9lbnRpdHlJZCA9IGZvcm0uZW50aXR5SWQ7CiAgICAgICAgc3VibWl0Rm9ybURhdGEuX2VudGl0eU5hbWUgPSBmb3JtLmVudGl0eU5hbWU7CiAgICAgIH0KICAgICAgYXdhaXQgYXBpLmNyZWF0ZVRpY2tldCh7CiAgICAgICAgdGl0bGU6IGZvcm0udGl0bGUgfHwgKGlzRHJhZnQgPyAnVW50aXRsZWQgRHJhZnQnIDogJycpLAogICAgICAgIGRlc2NyaXB0aW9uOiBmb3JtLmRlc2NyaXB0aW9uLAogICAgICAgIHRvRGVwYXJ0bWVudElkOiBmb3JtLnRvRGVwYXJ0bWVudElkLAogICAgICAgIHN1YnR5cGVJZDogZm9ybS5zdWJ0eXBlSWQsCiAgICAgICAgYXNzaWduZWRUb0lkOiBmb3JtLmFzc2lnbmVkVG9JZCwKICAgICAgICBwcmlvcml0eTogZm9ybS5wcmlvcml0eSwKICAgICAgICBkdWVEYXRlOiBmb3JtLmR1ZURhdGUsCiAgICAgICAgZm9ybURhdGE6IHN1Ym1pdEZvcm1EYXRhLAogICAgICAgIGF0dGFjaG1lbnRJZHM6IGF0dGFjaG1lbnRzLm1hcChhID0+IGEuaWQpLAogICAgICAgIHdhdGNoZXJJZHM6IGNjVXNlcklkcywKICAgICAgICBpc0RyYWZ0LAogICAgICB9KTsKICAgICAgb25DcmVhdGVkKCk7IG9uQ2xvc2UoKTsKICAgIH0gY2F0Y2ggKGVycjogYW55KSB7IHNldEVycm9yKGVyci5tZXNzYWdlKTsgfQogICAgZmluYWxseSB7IHNldExvYWRpbmcoZmFsc2UpOyB9CiAgfTsKCiAgY29uc3QgaGFuZGxlU3VibWl0ID0gYXN5bmMgKGU6IFJlYWN0LkZvcm1FdmVudCkgPT4gewogICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgYXdhaXQgZG9TdWJtaXQoZmFsc2UpOwogIH07CgogIGNvbnN0IHJlbmRlckZpZWxkSW5wdXQgPSAoZmllbGQ6IGFueSkgPT4gewogICAgY29uc3QgdmFsdWUgPSBmb3JtLmZvcm1EYXRhW2ZpZWxkLmlkXSA/PyAnJzsKICAgIGNvbnN0IG9uQ2hhbmdlID0gKHY6IGFueSkgPT4gc2V0Rm9ybSh7IC4uLmZvcm0sIGZvcm1EYXRhOiB7IC4uLmZvcm0uZm9ybURhdGEsIFtmaWVsZC5pZF06IHYgfSB9KTsKCiAgICBzd2l0Y2ggKGZpZWxkLnR5cGUpIHsKICAgICAgY2FzZSAnVEVYVCc6IHJldHVybiA8aW5wdXQgY2xhc3NOYW1lPSJ3LWZ1bGwgaC0xMCBweC0zIHJvdW5kZWQtbGcgYmctc2Vjb25kYXJ5IGJvcmRlciBib3JkZXItYm9yZGVyIHRleHQtc20iIHZhbHVlPXt2YWx1ZX0gb25DaGFuZ2U9eyhlKSA9PiBvbkNoYW5nZShlLnRhcmdldC52YWx1ZSl9IHBsYWNlaG9sZGVyPXtmaWVsZC5wbGFjZWhvbGRlcn0gLz47CiAgICAgIGNhc2UgJ1RFWFRBUkVBJzogcmV0dXJuIDx0ZXh0YXJlYSBjbGFzc05hbWU9InctZnVsbCBoLTI0IHB4LTMgcHktMiByb3VuZGVkLWxnIGJnLXNlY29uZGFyeSBib3JkZXIgYm9yZGVyLWJvcmRlciB0ZXh0LXNtIHJlc2l6ZS1ub25lIiB2YWx1ZT17dmFsdWV9IG9uQ2hhbmdlPXsoZSkgPT4gb25DaGFuZ2UoZS50YXJnZXQudmFsdWUpfSBwbGFjZWhvbGRlcj17ZmllbGQucGxhY2Vob2xkZXJ9IC8+OwogICAgICBjYXNlICdSSUNIX1RFWFQnOiByZXR1cm4gPFJpY2hUZXh0RWRpdG9yIHZhbHVlPXt2YWx1ZX0gb25DaGFuZ2U9e29uQ2hhbmdlfSBtaW5IZWlnaHQ9IjEwMHB4IiAvPjsKICAgICAgY2FzZSAnTlVNQkVSJzogcmV0dXJuIDxpbnB1dCB0eXBlPSJudW1iZXIiIGNsYXNzTmFtZT0idy1mdWxsIGgtMTAgcHgtMyByb3VuZGVkLWxnIGJnLXNlY29uZGFyeSBib3JkZXIgYm9yZGVyLWJvcmRlciB0ZXh0LXNtIiB2YWx1ZT17dmFsdWV9IG9uQ2hhbmdlPXsoZSkgPT4gb25DaGFuZ2UoZS50YXJnZXQudmFsdWUpfSBwbGFjZWhvbGRlcj17ZmllbGQucGxhY2Vob2xkZXJ9IC8+OwogICAgICBjYXNlICdEQVRFJzogcmV0dXJuIDxpbnB1dCB0eXBlPSJkYXRlIiBjbGFzc05hbWU9InctZnVsbCBoLTEwIHB4LTMgcm91bmRlZC1sZyBiZy1zZWNvbmRhcnkgYm9yZGVyIGJvcmRlci1ib3JkZXIgdGV4dC1zbSIgdmFsdWU9e3ZhbHVlfSBvbkNoYW5nZT17KGUpID0+IG9uQ2hhbmdlKGUudGFyZ2V0LnZhbHVlKX0gLz47CiAgICAgIGNhc2UgJ0RBVEVUSU1FJzogcmV0dXJuIDxpbnB1dCB0eXBlPSJkYXRldGltZS1sb2NhbCIgY2xhc3NOYW1lPSJ3LWZ1bGwgaC0xMCBweC0zIHJvdW5kZWQtbGcgYmctc2Vjb25kYXJ5IGJvcmRlciBib3JkZXItYm9yZGVyIHRleHQtc20iIHZhbHVlPXt2YWx1ZX0gb25DaGFuZ2U9eyhlKSA9PiBvbkNoYW5nZShlLnRhcmdldC52YWx1ZSl9IC8+OwogICAgICBjYXNlICdTRUxFQ1QnOiBjYXNlICdERVBBUlRNRU5UX1NFTEVDVE9SJzogY2FzZSAnVVNFUl9TRUxFQ1RPUic6IHJldHVybiAoCiAgICAgICAgPHNlbGVjdCBjbGFzc05hbWU9InctZnVsbCBoLTEwIHB4LTMgcm91bmRlZC1sZyBiZy1zZWNvbmRhcnkgYm9yZGVyIGJvcmRlci1ib3JkZXIgdGV4dC1zbSIgdmFsdWU9e3ZhbHVlfSBvbkNoYW5nZT17KGUpID0+IG9uQ2hhbmdlKGUudGFyZ2V0LnZhbHVlKX0+CiAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPlNlbGVjdC4uLjwvb3B0aW9uPgogICAgICAgICAge2ZpZWxkLm9wdGlvbnM/Lm1hcCgobzogc3RyaW5nKSA9PiA8b3B0aW9uIGtleT17b30gdmFsdWU9e299PntvfTwvb3B0aW9uPil9CiAgICAgICAgPC9zZWxlY3Q+CiAgICAgICk7CiAgICAgIGNhc2UgJ01VTFRJX1NFTEVDVCc6IHJldHVybiAoCiAgICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXggZmxleC13cmFwIGdhcC0yIj4KICAgICAgICAgIHtmaWVsZC5vcHRpb25zPy5tYXAoKG86IHN0cmluZykgPT4gKAogICAgICAgICAgICA8bGFiZWwga2V5PXtvfSBjbGFzc05hbWU9ImZsZXggaXRlbXMtY2VudGVyIGdhcC0xLjUgdGV4dC1zbSBjdXJzb3ItcG9pbnRlciI+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBjaGVja2VkPXsodmFsdWUgfHwgW10pLmluY2x1ZGVzKG8pfSBvbkNoYW5nZT17KGUpID0+IHsKICAgICAgICAgICAgICAgIGNvbnN0IGFyciA9IHZhbHVlIHx8IFtdOwogICAgICAgICAgICAgICAgb25DaGFuZ2UoZS50YXJnZXQuY2hlY2tlZCA/IFsuLi5hcnIsIG9dIDogYXJyLmZpbHRlcigoeDogc3RyaW5nKSA9PiB4ICE9PSBvKSk7CiAgICAgICAgICAgICAgfX0gY2xhc3NOYW1lPSJyb3VuZGVkIiAvPiB7b30KICAgICAgICAgICAgPC9sYWJlbD4KICAgICAgICAgICkpfQogICAgICAgIDwvZGl2PgogICAgICApOwogICAgICBjYXNlICdSQURJT19HUk9VUCc6IHJldHVybiAoCiAgICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXggZmxleC13cmFwIGdhcC0zIj4KICAgICAgICAgIHtmaWVsZC5vcHRpb25zPy5tYXAoKG86IHN0cmluZykgPT4gKAogICAgICAgICAgICA8bGFiZWwga2V5PXtvfSBjbGFzc05hbWU9ImZsZXggaXRlbXMtY2VudGVyIGdhcC0xLjUgdGV4dC1zbSBjdXJzb3ItcG9pbnRlciI+CiAgICAgICAgICAgICAgPGlucHV0IHR5cGU9InJhZGlvIiBuYW1lPXtmaWVsZC5pZH0gY2hlY2tlZD17dmFsdWUgPT09IG99IG9uQ2hhbmdlPXsoKSA9PiBvbkNoYW5nZShvKX0gLz4ge299CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICApKX0KICAgICAgICA8L2Rpdj4KICAgICAgKTsKICAgICAgY2FzZSAnQ0hFQ0tCT1gnOiByZXR1cm4gKAogICAgICAgIDxsYWJlbCBjbGFzc05hbWU9ImZsZXggaXRlbXMtY2VudGVyIGdhcC0yIHRleHQtc20gY3Vyc29yLXBvaW50ZXIiPgogICAgICAgICAgPGlucHV0IHR5cGU9ImNoZWNrYm94IiBjaGVja2VkPXshIXZhbHVlfSBvbkNoYW5nZT17KGUpID0+IG9uQ2hhbmdlKGUudGFyZ2V0LmNoZWNrZWQpfSBjbGFzc05hbWU9InJvdW5kZWQiIC8+IHtmaWVsZC5sYWJlbH0KICAgICAgICA8L2xhYmVsPgogICAgICApOwogICAgICBjYXNlICdGSUxFX1VQTE9BRCc6IGNhc2UgJ0lNQUdFX1VQTE9BRCc6IHJldHVybiAoCiAgICAgICAgPEZpbGVBdHRhY2htZW50CiAgICAgICAgICBmaWxlcz17KGZvcm0uZm9ybURhdGFbYCR7ZmllbGQuaWR9X2ZpbGVzYF0gfHwgW10pIGFzIFVwbG9hZGVkRmlsZVtdfQogICAgICAgICAgb25DaGFuZ2U9eyhmKSA9PiBzZXRGb3JtKHsgLi4uZm9ybSwgZm9ybURhdGE6IHsgLi4uZm9ybS5mb3JtRGF0YSwgW2Ake2ZpZWxkLmlkfV9maWxlc2BdOiBmLCBbZmllbGQuaWRdOiBmLm1hcCh4ID0+IHguaWQpIH0gfSl9CiAgICAgICAgICBhY2NlcHQ9e2ZpZWxkLnR5cGUgPT09ICdJTUFHRV9VUExPQUQnID8gJ2ltYWdlLyonIDogdW5kZWZpbmVkfQogICAgICAgICAgY29tcGFjdAogICAgICAgIC8+CiAgICAgICk7CiAgICAgIGNhc2UgJ0VOVElUWV9UWVBFJzogcmV0dXJuICgKICAgICAgICA8RW50aXR5VHlwZVNlbGVjdG9yCiAgICAgICAgICB2YWx1ZT17Zm9ybS5mb3JtRGF0YVtmaWVsZC5pZF0gfHwge319CiAgICAgICAgICBvbkNoYW5nZT17KHY6IGFueSkgPT4gc2V0Rm9ybSh7IC4uLmZvcm0sIGZvcm1EYXRhOiB7IC4uLmZvcm0uZm9ybURhdGEsIFtmaWVsZC5pZF06IHYgfSB9KX0KICAgICAgICAvPgogICAgICApOwogICAgICBkZWZhdWx0OiByZXR1cm4gPGlucHV0IGNsYXNzTmFtZT0idy1mdWxsIGgtMTAgcHgtMyByb3VuZGVkLWxnIGJnLXNlY29uZGFyeSBib3JkZXIgYm9yZGVyLWJvcmRlciB0ZXh0LXNtIiB2YWx1ZT17dmFsdWV9IG9uQ2hhbmdlPXsoZSkgPT4gb25DaGFuZ2UoZS50YXJnZXQudmFsdWUpfSBwbGFjZWhvbGRlcj17ZmllbGQucGxhY2Vob2xkZXJ9IC8+OwogICAgfQogIH07CgogIC8vIFJlbmRlciBhIGZpZWxkIHdpdGggaXRzIGxhYmVsLCByZXNwZWN0aW5nIGNvbFNwYW4gYW5kIEdST1VQIG5lc3RpbmcKICBjb25zdCByZW5kZXJEeW5hbWljRmllbGQgPSAoZmllbGQ6IGFueSk6IFJlYWN0LlJlYWN0Tm9kZSA9PiB7CiAgICAvLyBDb25kaXRpb25hbCB2aXNpYmlsaXR5CiAgICBpZiAoZmllbGQuY29uZGl0aW9uKSB7CiAgICAgIGNvbnN0IGRlcFZhbHVlID0gZm9ybS5mb3JtRGF0YVtmaWVsZC5jb25kaXRpb24uZmllbGRdOwogICAgICBpZiAoZGVwVmFsdWUgIT09IGZpZWxkLmNvbmRpdGlvbi52YWx1ZSkgcmV0dXJuIG51bGw7CiAgICB9CgogICAgLy8gR1JPVVAgdHlwZTogcmVuZGVyIGFzIGEgc2VjdGlvbiB3aXRoIG5lc3RlZCBncmlkCiAgICBpZiAoZmllbGQudHlwZSA9PT0gJ0dST1VQJykgewogICAgICBjb25zdCB2aXNpYmxlQ2hpbGRyZW4gPSAoZmllbGQuY2hpbGRyZW4gfHwgW10pLmZpbHRlcigoY2hpbGQ6IGFueSkgPT4gewogICAgICAgIGlmICghY2hpbGQuY29uZGl0aW9uKSByZXR1cm4gdHJ1ZTsKICAgICAgICByZXR1cm4gZm9ybS5mb3JtRGF0YVtjaGlsZC5jb25kaXRpb24uZmllbGRdID09PSBjaGlsZC5jb25kaXRpb24udmFsdWU7CiAgICAgIH0pOwogICAgICBpZiAodmlzaWJsZUNoaWxkcmVuLmxlbmd0aCA9PT0gMCAmJiAhZmllbGQubGFiZWwpIHJldHVybiBudWxsOwogICAgICByZXR1cm4gKAogICAgICAgIDxkaXYKICAgICAgICAgIGtleT17ZmllbGQuaWR9CiAgICAgICAgICBjbGFzc05hbWU9ImJvcmRlciBib3JkZXItYm9yZGVyIHJvdW5kZWQteGwgcC00IGJnLWFjY2VudC8yMCIKICAgICAgICAgIHN0eWxlPXt7IGdyaWRDb2x1bW46IGBzcGFuICR7TWF0aC5taW4oZmllbGQuY29sU3BhbiB8fCAxMiwgMTIpfWAgfX0KICAgICAgICA+CiAgICAgICAgICB7ZmllbGQubGFiZWwgJiYgPGg0IGNsYXNzTmFtZT0idGV4dC1zbSBmb250LXNlbWlib2xkIG1iLTEiPntmaWVsZC5sYWJlbH08L2g0Pn0KICAgICAgICAgIHtmaWVsZC5kZXNjcmlwdGlvbiAmJiA8cCBjbGFzc05hbWU9InRleHQteHMgdGV4dC1tdXRlZC1mb3JlZ3JvdW5kIG1iLTMiPntmaWVsZC5kZXNjcmlwdGlvbn08L3A+fQogICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImdyaWQgZ3JpZC1jb2xzLTEyIGdhcC00Ij4KICAgICAgICAgICAgeyhmaWVsZC5jaGlsZHJlbiB8fCBbXSkubWFwKChjaGlsZDogYW55KSA9PiByZW5kZXJEeW5hbWljRmllbGQoY2hpbGQpKX0KICAgICAgICAgIDwvZGl2PgogICAgICAgIDwvZGl2PgogICAgICApOwogICAgfQoKICAgIC8vIFJFUEVBVEVSIHR5cGU6IHJlbmRlciBhcyBhbiBlZGl0YWJsZSB0YWJsZSB3aXRoIGFkZC9yZW1vdmUgcm93cwogICAgaWYgKGZpZWxkLnR5cGUgPT09ICdSRVBFQVRFUicpIHsKICAgICAgY29uc3QgY29scyA9IGZpZWxkLmNvbHVtbnMgfHwgW107CiAgICAgIGNvbnN0IHJvd3M6IGFueVtdID0gZm9ybS5mb3JtRGF0YVtmaWVsZC5pZF0gfHwgW107CiAgICAgIGNvbnN0IG1pblJvd3MgPSBmaWVsZC5taW5Sb3dzIHx8IDE7CiAgICAgIGNvbnN0IG1heFJvd3MgPSBmaWVsZC5tYXhSb3dzIHx8IDUwOwoKICAgICAgLy8gRW5zdXJlIG1pbmltdW0gcm93cyBleGlzdAogICAgICBpZiAocm93cy5sZW5ndGggPCBtaW5Sb3dzKSB7CiAgICAgICAgY29uc3QgZW1wdHlSb3c6IGFueSA9IHt9OwogICAgICAgIGNvbHMuZm9yRWFjaCgoYzogYW55KSA9PiB7IGVtcHR5Um93W2MuaWRdID0gJyc7IH0pOwogICAgICAgIGNvbnN0IHBhZGRlZCA9IFsuLi5yb3dzXTsKICAgICAgICB3aGlsZSAocGFkZGVkLmxlbmd0aCA8IG1pblJvd3MpIHBhZGRlZC5wdXNoKHsgLi4uZW1wdHlSb3cgfSk7CiAgICAgICAgLy8gSW1tZWRpYXRlbHkgc2V0CiAgICAgICAgaWYgKHJvd3MubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsKICAgICAgICAgICAgc2V0Rm9ybSgocHJldjogYW55KSA9PiAoeyAuLi5wcmV2LCBmb3JtRGF0YTogeyAuLi5wcmV2LmZvcm1EYXRhLCBbZmllbGQuaWRdOiBwYWRkZWQgfSB9KSk7CiAgICAgICAgICB9LCAwKTsKICAgICAgICB9CiAgICAgIH0KCiAgICAgIGNvbnN0IGFkZFJvdyA9ICgpID0+IHsKICAgICAgICBpZiAocm93cy5sZW5ndGggPj0gbWF4Um93cykgcmV0dXJuOwogICAgICAgIGNvbnN0IGVtcHR5Um93OiBhbnkgPSB7fTsKICAgICAgICBjb2xzLmZvckVhY2goKGM6IGFueSkgPT4geyBlbXB0eVJvd1tjLmlkXSA9ICcnOyB9KTsKICAgICAgICBzZXRGb3JtKHsgLi4uZm9ybSwgZm9ybURhdGE6IHsgLi4uZm9ybS5mb3JtRGF0YSwgW2ZpZWxkLmlkXTogWy4uLnJvd3MsIGVtcHR5Um93XSB9IH0pOwogICAgICB9OwoKICAgICAgY29uc3QgcmVtb3ZlUm93ID0gKGlkeDogbnVtYmVyKSA9PiB7CiAgICAgICAgaWYgKHJvd3MubGVuZ3RoIDw9IG1pblJvd3MpIHJldHVybjsKICAgICAgICBzZXRGb3JtKHsgLi4uZm9ybSwgZm9ybURhdGE6IHsgLi4uZm9ybS5mb3JtRGF0YSwgW2ZpZWxkLmlkXTogcm93cy5maWx0ZXIoKF86IGFueSwgaTogbnVtYmVyKSA9PiBpICE9PSBpZHgpIH0gfSk7CiAgICAgIH07CgogICAgICBjb25zdCB1cGRhdGVDZWxsID0gKHJvd0lkeDogbnVtYmVyLCBjb2xJZDogc3RyaW5nLCB2YWx1ZTogYW55KSA9PiB7CiAgICAgICAgY29uc3QgdXBkYXRlZCA9IFsuLi5yb3dzXTsKICAgICAgICB1cGRhdGVkW3Jvd0lkeF0gPSB7IC4uLnVwZGF0ZWRbcm93SWR4XSwgW2NvbElkXTogdmFsdWUgfTsKICAgICAgICBzZXRGb3JtKHsgLi4uZm9ybSwgZm9ybURhdGE6IHsgLi4uZm9ybS5mb3JtRGF0YSwgW2ZpZWxkLmlkXTogdXBkYXRlZCB9IH0pOwogICAgICB9OwoKICAgICAgY29uc3QgcmVuZGVyQ2VsbElucHV0ID0gKGNvbDogYW55LCByb3dJZHg6IG51bWJlcikgPT4gewogICAgICAgIGNvbnN0IHZhbCA9IHJvd3Nbcm93SWR4XT8uW2NvbC5pZF0gPz8gJyc7CiAgICAgICAgc3dpdGNoIChjb2wudHlwZSkgewogICAgICAgICAgY2FzZSAnTlVNQkVSJzogcmV0dXJuIDxpbnB1dCB0eXBlPSJudW1iZXIiIGNsYXNzTmFtZT0idy1mdWxsIGgtOSBweC0yIHJvdW5kZWQtbGcgYmctc2Vjb25kYXJ5IGJvcmRlciBib3JkZXItYm9yZGVyIHRleHQtc20iIHZhbHVlPXt2YWx9IG9uQ2hhbmdlPXtlID0+IHVwZGF0ZUNlbGwocm93SWR4LCBjb2wuaWQsIGUudGFyZ2V0LnZhbHVlKX0gcGxhY2Vob2xkZXI9e2NvbC5wbGFjZWhvbGRlcn0gLz47CiAgICAgICAgICBjYXNlICdTRUxFQ1QnOiByZXR1cm4gKAogICAgICAgICAgICA8c2VsZWN0IGNsYXNzTmFtZT0idy1mdWxsIGgtOSBweC0yIHJvdW5kZWQtbGcgYmctc2Vjb25kYXJ5IGJvcmRlciBib3JkZXItYm9yZGVyIHRleHQtc20iIHZhbHVlPXt2YWx9IG9uQ2hhbmdlPXtlID0+IHVwZGF0ZUNlbGwocm93SWR4LCBjb2wuaWQsIGUudGFyZ2V0LnZhbHVlKX0+CiAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj5TZWxlY3QuLi48L29wdGlvbj4KICAgICAgICAgICAgICB7KGNvbC5vcHRpb25zIHx8IFtdKS5tYXAoKG86IHN0cmluZykgPT4gPG9wdGlvbiBrZXk9e299IHZhbHVlPXtvfT57b308L29wdGlvbj4pfQogICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICk7CiAgICAgICAgICBjYXNlICdEQVRFJzogcmV0dXJuIDxpbnB1dCB0eXBlPSJkYXRlIiBjbGFzc05hbWU9InctZnVsbCBoLTkgcHgtMiByb3VuZGVkLWxnIGJnLXNlY29uZGFyeSBib3JkZXIgYm9yZGVyLWJvcmRlciB0ZXh0LXNtIiB2YWx1ZT17dmFsfSBvbkNoYW5nZT17ZSA9PiB1cGRhdGVDZWxsKHJvd0lkeCwgY29sLmlkLCBlLnRhcmdldC52YWx1ZSl9IC8+OwogICAgICAgICAgY2FzZSAnQ0hFQ0tCT1gnOiByZXR1cm4gPGlucHV0IHR5cGU9ImNoZWNrYm94IiBjaGVja2VkPXshIXZhbH0gb25DaGFuZ2U9e2UgPT4gdXBkYXRlQ2VsbChyb3dJZHgsIGNvbC5pZCwgZS50YXJnZXQuY2hlY2tlZCl9IGNsYXNzTmFtZT0icm91bmRlZCIgLz47CiAgICAgICAgICBjYXNlICdURVhUQVJFQSc6IHJldHVybiA8dGV4dGFyZWEgY2xhc3NOYW1lPSJ3LWZ1bGwgaC0xNiBweC0yIHB5LTEgcm91bmRlZC1sZyBiZy1zZWNvbmRhcnkgYm9yZGVyIGJvcmRlci1ib3JkZXIgdGV4dC1zbSByZXNpemUtbm9uZSIgdmFsdWU9e3ZhbH0gb25DaGFuZ2U9e2UgPT4gdXBkYXRlQ2VsbChyb3dJZHgsIGNvbC5pZCwgZS50YXJnZXQudmFsdWUpfSBwbGFjZWhvbGRlcj17Y29sLnBsYWNlaG9sZGVyfSAvPjsKICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiA8aW5wdXQgY2xhc3NOYW1lPSJ3LWZ1bGwgaC05IHB4LTIgcm91bmRlZC1sZyBiZy1zZWNvbmRhcnkgYm9yZGVyIGJvcmRlci1ib3JkZXIgdGV4dC1zbSIgdmFsdWU9e3ZhbH0gb25DaGFuZ2U9e2UgPT4gdXBkYXRlQ2VsbChyb3dJZHgsIGNvbC5pZCwgZS50YXJnZXQudmFsdWUpfSBwbGFjZWhvbGRlcj17Y29sLnBsYWNlaG9sZGVyfSAvPjsKICAgICAgICB9CiAgICAgIH07CgogICAgICByZXR1cm4gKAogICAgICAgIDxkaXYga2V5PXtmaWVsZC5pZH0gc3R5bGU9e3sgZ3JpZENvbHVtbjogYHNwYW4gJHtNYXRoLm1pbihmaWVsZC5jb2xTcGFuIHx8IDEyLCAxMil9YCB9fT4KICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJmbGV4IGl0ZW1zLWNlbnRlciBqdXN0aWZ5LWJldHdlZW4gbWItMiI+CiAgICAgICAgICAgIDxsYWJlbCBjbGFzc05hbWU9InRleHQtc20gZm9udC1tZWRpdW0iPgogICAgICAgICAgICAgIHtmaWVsZC5sYWJlbH0ge2ZpZWxkLnJlcXVpcmVkICYmIDxzcGFuIGNsYXNzTmFtZT0idGV4dC1kZXN0cnVjdGl2ZSI+Kjwvc3Bhbj59CiAgICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgICAgIDxidXR0b24gdHlwZT0iYnV0dG9uIiBvbkNsaWNrPXthZGRSb3d9IGRpc2FibGVkPXtyb3dzLmxlbmd0aCA+PSBtYXhSb3dzfQogICAgICAgICAgICAgIGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTEgdGV4dC14cyB0ZXh0LXByaW1hcnkgaG92ZXI6dW5kZXJsaW5lIGRpc2FibGVkOm9wYWNpdHktNDAgZGlzYWJsZWQ6bm8tdW5kZXJsaW5lIj4KICAgICAgICAgICAgICA8UGx1cyBzaXplPXsxMn0gLz4gQWRkIHJvdwogICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImJvcmRlciBib3JkZXItYm9yZGVyIHJvdW5kZWQteGwgb3ZlcmZsb3ctaGlkZGVuIj4KICAgICAgICAgICAgey8qIEhlYWRlciAqL30KICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImdyaWQgYmctYWNjZW50LzUwIiBzdHlsZT17eyBncmlkVGVtcGxhdGVDb2x1bW5zOiBgcmVwZWF0KCR7Y29scy5sZW5ndGh9LCAxZnIpIDU2cHhgIH19PgogICAgICAgICAgICAgIHtjb2xzLm1hcCgoY29sOiBhbnkpID0+ICgKICAgICAgICAgICAgICAgIDxkaXYga2V5PXtjb2wuaWR9IGNsYXNzTmFtZT0icHgtMyBweS0yIHRleHQteHMgZm9udC1zZW1pYm9sZCBib3JkZXItciBib3JkZXItYm9yZGVyIGxhc3Q6Ym9yZGVyLXItMCI+CiAgICAgICAgICAgICAgICAgIHtjb2wubGFiZWx9e2NvbC5yZXF1aXJlZCA/ICcgKicgOiAnJ30KICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICkpfQogICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJweC0yIHB5LTIgdGV4dC14cyB0ZXh0LW11dGVkLWZvcmVncm91bmQiIC8+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICB7LyogUm93cyAqL30KICAgICAgICAgICAgeyhyb3dzLmxlbmd0aCA+IDAgPyByb3dzIDogW3t9XSkubWFwKChyb3c6IGFueSwgcm93SWR4OiBudW1iZXIpID0+ICgKICAgICAgICAgICAgICA8ZGl2IGtleT17cm93SWR4fSBjbGFzc05hbWU9ImdyaWQgYm9yZGVyLXQgYm9yZGVyLWJvcmRlciIgc3R5bGU9e3sgZ3JpZFRlbXBsYXRlQ29sdW1uczogYHJlcGVhdCgke2NvbHMubGVuZ3RofSwgMWZyKSA1NnB4YCB9fT4KICAgICAgICAgICAgICAgIHtjb2xzLm1hcCgoY29sOiBhbnkpID0+ICgKICAgICAgICAgICAgICAgICAgPGRpdiBrZXk9e2NvbC5pZH0gY2xhc3NOYW1lPSJweC0yIHB5LTEuNSBib3JkZXItciBib3JkZXItYm9yZGVyIGxhc3Q6Ym9yZGVyLXItMCI+CiAgICAgICAgICAgICAgICAgICAge3JlbmRlckNlbGxJbnB1dChjb2wsIHJvd0lkeCl9CiAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgKSl9CiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0icHgtMiBweS0xLjUgZmxleCBpdGVtcy1jZW50ZXIganVzdGlmeS1jZW50ZXIiPgogICAgICAgICAgICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgb25DbGljaz17KCkgPT4gcmVtb3ZlUm93KHJvd0lkeCl9IGRpc2FibGVkPXtyb3dzLmxlbmd0aCA8PSBtaW5Sb3dzfQogICAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT0idGV4dC14cyB0ZXh0LWRlc3RydWN0aXZlIGhvdmVyOnVuZGVybGluZSBkaXNhYmxlZDpvcGFjaXR5LTMwIGRpc2FibGVkOm5vLXVuZGVybGluZSI+CiAgICAgICAgICAgICAgICAgICAgUmVtb3ZlCiAgICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICkpfQogICAgICAgICAgPC9kaXY+CiAgICAgICAgICA8cCBjbGFzc05hbWU9InRleHQtWzEwcHhdIHRleHQtbXV0ZWQtZm9yZWdyb3VuZCBtdC0xIj4KICAgICAgICAgICAge3Jvd3MubGVuZ3RofSByb3d7cm93cy5sZW5ndGggIT09IDEgPyAncycgOiAnJ30gwrcge21pblJvd3N9IG1pbiwge21heFJvd3N9IG1heAogICAgICAgICAgPC9wPgogICAgICAgIDwvZGl2PgogICAgICApOwogICAgfQoKICAgIC8vIFJlZ3VsYXIgZmllbGQ6IHJlbmRlciBsYWJlbCArIGlucHV0IHJlc3BlY3RpbmcgY29sU3BhbgogICAgY29uc3QgaW5wdXQgPSByZW5kZXJGaWVsZElucHV0KGZpZWxkKTsKICAgIGlmICghaW5wdXQpIHJldHVybiBudWxsOwoKICAgIHJldHVybiAoCiAgICAgIDxkaXYKICAgICAgICBrZXk9e2ZpZWxkLmlkfQogICAgICAgIHN0eWxlPXt7IGdyaWRDb2x1bW46IGBzcGFuICR7TWF0aC5taW4oZmllbGQuY29sU3BhbiB8fCAxMiwgMTIpfWAgfX0KICAgICAgPgogICAgICAgIHtmaWVsZC50eXBlICE9PSAnQ0hFQ0tCT1gnICYmICgKICAgICAgICAgIDxsYWJlbCBjbGFzc05hbWU9ImJsb2NrIHRleHQtc20gZm9udC1tZWRpdW0gbWItMS41Ij4KICAgICAgICAgICAge2ZpZWxkLmxhYmVsfSB7ZmllbGQucmVxdWlyZWQgJiYgPHNwYW4gY2xhc3NOYW1lPSJ0ZXh0LWRlc3RydWN0aXZlIj4qPC9zcGFuPn0KICAgICAgICAgIDwvbGFiZWw+CiAgICAgICAgKX0KICAgICAgICB7aW5wdXR9CiAgICAgIDwvZGl2PgogICAgKTsKICB9OwoKICBpZiAoIW9wZW4pIHJldHVybiBudWxsOwogIHJldHVybiAoCiAgICA8ZGl2IGNsYXNzTmFtZT0iZml4ZWQgaW5zZXQtMCB6LTUwIGZsZXggaXRlbXMtc3RhcnQganVzdGlmeS1jZW50ZXIgYmctYmxhY2svNjAgYmFja2Ryb3AtYmx1ci1zbSBwdC1bNXZoXSIgb25DbGljaz17b25DbG9zZX0+CiAgICAgIDxkaXYgY2xhc3NOYW1lPSJiZy1jYXJkIGJvcmRlciBib3JkZXItYm9yZGVyIHJvdW5kZWQtMnhsIHctZnVsbCBtYXgtdy0yeGwgbWF4LWgtWzkwdmhdIG92ZXJmbG93LXktYXV0byBtLTQgc2hhZG93LTJ4bCIgb25DbGljaz17KGUpID0+IGUuc3RvcFByb3BhZ2F0aW9uKCl9PgogICAgICAgIDxkaXYgY2xhc3NOYW1lPSJwLTYgYm9yZGVyLWIgYm9yZGVyLWJvcmRlciBzdGlja3kgdG9wLTAgYmctY2FyZCB6LTEwIHJvdW5kZWQtdC0yeGwiPgogICAgICAgICAgPGgyIGNsYXNzTmFtZT0idGV4dC1sZyBmb250LWJvbGQiPk5ldyBSZXF1ZXN0PC9oMj4KICAgICAgICAgIDxwIGNsYXNzTmFtZT0idGV4dC14cyB0ZXh0LW11dGVkLWZvcmVncm91bmQgbXQtMC41Ij5DcmVhdGUgYSBuZXcgaW50ZXItZGVwYXJ0bWVudCByZXF1ZXN0PC9wPgogICAgICAgIDwvZGl2PgogICAgICAgIDxmb3JtIG9uU3VibWl0PXtoYW5kbGVTdWJtaXR9IGNsYXNzTmFtZT0icC02IHNwYWNlLXktNSI+CiAgICAgICAgICB7LyogRGVwYXJ0bWVudCArIFR5cGUgKi99CiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iZ3JpZCBncmlkLWNvbHMtMiBnYXAtNCI+CiAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzTmFtZT0iYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSBtYi0xLjUiPlRvIERlcGFydG1lbnQgPHNwYW4gY2xhc3NOYW1lPSJ0ZXh0LWRlc3RydWN0aXZlIj4qPC9zcGFuPjwvbGFiZWw+CiAgICAgICAgICAgICAgPHNlbGVjdCBjbGFzc05hbWU9InctZnVsbCBoLTEwIHB4LTMgcm91bmRlZC1sZyBiZy1zZWNvbmRhcnkgYm9yZGVyIGJvcmRlci1ib3JkZXIgdGV4dC1zbSIgdmFsdWU9e2Zvcm0udG9EZXBhcnRtZW50SWR9IG9uQ2hhbmdlPXsoZSkgPT4gc2V0Rm9ybSh7IC4uLmZvcm0sIHRvRGVwYXJ0bWVudElkOiBlLnRhcmdldC52YWx1ZSwgc3VidHlwZUlkOiAnJyB9KX0gcmVxdWlyZWQ+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPlNlbGVjdCBkZXBhcnRtZW50PC9vcHRpb24+CiAgICAgICAgICAgICAgICB7ZGVwYXJ0bWVudHMubWFwKChkOiBhbnkpID0+ICgKICAgICAgICAgICAgICAgICAgPG9wdGlvbiBrZXk9e2QuaWR9IHZhbHVlPXtkLmlkfT57ZC5uYW1lfTwvb3B0aW9uPgogICAgICAgICAgICAgICAgKSl9CiAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxsYWJlbCBjbGFzc05hbWU9ImJsb2NrIHRleHQtc20gZm9udC1tZWRpdW0gbWItMS41Ij5SZXF1ZXN0IFR5cGU8L2xhYmVsPgogICAgICAgICAgICAgIDxzZWxlY3QgY2xhc3NOYW1lPSJ3LWZ1bGwgaC0xMCBweC0zIHJvdW5kZWQtbGcgYmctc2Vjb25kYXJ5IGJvcmRlciBib3JkZXItYm9yZGVyIHRleHQtc20iIHZhbHVlPXtmb3JtLnN1YnR5cGVJZH0gb25DaGFuZ2U9eyhlKSA9PiBzZXRGb3JtKHsgLi4uZm9ybSwgc3VidHlwZUlkOiBlLnRhcmdldC52YWx1ZSB9KX0+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPkdlbmVyYWwgcmVxdWVzdDwvb3B0aW9uPgogICAgICAgICAgICAgICAge2NhdGVnb3JpZXMubWFwKChjYXQ6IGFueSkgPT4gKAogICAgICAgICAgICAgICAgICA8b3B0Z3JvdXAga2V5PXtjYXQuaWR9IGxhYmVsPXtjYXQubmFtZX0+CiAgICAgICAgICAgICAgICAgICAge2NhdC5zdWJ0eXBlcz8ubWFwKChzdDogYW55KSA9PiA8b3B0aW9uIGtleT17c3QuaWR9IHZhbHVlPXtzdC5pZH0+e3N0Lm5hbWV9PC9vcHRpb24+KX0KICAgICAgICAgICAgICAgICAgPC9vcHRncm91cD4KICAgICAgICAgICAgICAgICkpfQogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgIHsvKiBUaXRsZSAqL30KICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgIDxsYWJlbCBjbGFzc05hbWU9ImJsb2NrIHRleHQtc20gZm9udC1tZWRpdW0gbWItMS41Ij5UaXRsZSA8c3BhbiBjbGFzc05hbWU9InRleHQtZGVzdHJ1Y3RpdmUiPio8L3NwYW4+PC9sYWJlbD4KICAgICAgICAgICAgPGlucHV0IGNsYXNzTmFtZT0idy1mdWxsIGgtMTAgcHgtMyByb3VuZGVkLWxnIGJnLXNlY29uZGFyeSBib3JkZXIgYm9yZGVyLWJvcmRlciB0ZXh0LXNtIiB2YWx1ZT17Zm9ybS50aXRsZX0gb25DaGFuZ2U9eyhlKSA9PiBzZXRGb3JtKHsgLi4uZm9ybSwgdGl0bGU6IGUudGFyZ2V0LnZhbHVlIH0pfSBwbGFjZWhvbGRlcj0iQnJpZWYgc3VtbWFyeSBvZiB5b3VyIHJlcXVlc3QiIHJlcXVpcmVkIC8+CiAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICB7LyogRGVzY3JpcHRpb24g4oCUIFJpY2ggVGV4dCBFZGl0b3IgKi99CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICA8bGFiZWwgY2xhc3NOYW1lPSJibG9jayB0ZXh0LXNtIGZvbnQtbWVkaXVtIG1iLTEuNSI+RGVzY3JpcHRpb24gPHNwYW4gY2xhc3NOYW1lPSJ0ZXh0LWRlc3RydWN0aXZlIj4qPC9zcGFuPjwvbGFiZWw+CiAgICAgICAgICAgIDxSaWNoVGV4dEVkaXRvcgogICAgICAgICAgICAgIHZhbHVlPXtmb3JtLmRlc2NyaXB0aW9ufQogICAgICAgICAgICAgIG9uQ2hhbmdlPXsodmFsKSA9PiBzZXRGb3JtKHsgLi4uZm9ybSwgZGVzY3JpcHRpb246IHZhbCB9KX0KICAgICAgICAgICAgICBwbGFjZWhvbGRlcj0iRGVzY3JpYmUgeW91ciByZXF1ZXN0IGluIGRldGFpbC4uLiBZb3UgY2FuIHBhc3RlIGltYWdlcyBkaXJlY3RseSBoZXJlLiIKICAgICAgICAgICAgICBtaW5IZWlnaHQ9IjE4MHB4IgogICAgICAgICAgICAgIG9uRmlsZXNDaGFuZ2U9e3NldEF0dGFjaG1lbnRzfQogICAgICAgICAgICAvPgogICAgICAgICAgPC9kaXY+CgogICAgICAgICAgey8qIENsaWVudCAvIFN1cHBsaWVyIHNlbGVjdG9yICovfQogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgPGxhYmVsIGNsYXNzTmFtZT0iYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSBtYi0xLjUiPlJlbGF0ZWQgRW50aXR5PC9sYWJlbD4KICAgICAgICAgICAgPEVudGl0eVR5cGVTZWxlY3RvcgogICAgICAgICAgICAgIHZhbHVlPXt7IHR5cGU6IChmb3JtLmVudGl0eVR5cGUgYXMgYW55KSB8fCAnJywgaWQ6IGZvcm0uZW50aXR5SWQsIG5hbWU6IGZvcm0uZW50aXR5TmFtZSB9fQogICAgICAgICAgICAgIG9uQ2hhbmdlPXsodikgPT4gc2V0Rm9ybSh7IC4uLmZvcm0sIGVudGl0eVR5cGU6IHYudHlwZSB8fCAnJywgZW50aXR5SWQ6IHYuaWQgfHwgJycsIGVudGl0eU5hbWU6IHYubmFtZSB8fCAnJyB9KX0KICAgICAgICAgICAgLz4KICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgIHsvKiBEeW5hbWljIGZvcm0gZmllbGRzIGZyb20gc3VidHlwZSBzY2hlbWEg4oCUIHJlbmRlcmVkIGFzIGEgMTItY29sIGdyaWQgKi99CiAgICAgICAgICB7c2VsZWN0ZWRTdWJ0eXBlPy5mb3JtU2NoZW1hPy5zY2hlbWE/LmZpZWxkcz8ubGVuZ3RoID4gMCAmJiAoCiAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJncmlkIGdyaWQtY29scy0xMiBnYXAtNCI+CiAgICAgICAgICAgICAge3NlbGVjdGVkU3VidHlwZS5mb3JtU2NoZW1hLnNjaGVtYS5maWVsZHMubWFwKChmaWVsZDogYW55KSA9PiByZW5kZXJEeW5hbWljRmllbGQoZmllbGQpKX0KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICApfQoKICAgICAgICAgIHsvKiBBdHRhY2htZW50cyB6b25lIChzZXBhcmF0ZSBmcm9tIGlubGluZSkgKi99CiAgICAgICAgICA8ZGl2PgogICAgICAgICAgICA8bGFiZWwgY2xhc3NOYW1lPSJibG9jayB0ZXh0LXNtIGZvbnQtbWVkaXVtIG1iLTEuNSI+QWRkaXRpb25hbCBBdHRhY2htZW50czwvbGFiZWw+CiAgICAgICAgICAgIDxGaWxlQXR0YWNobWVudCBmaWxlcz17YXR0YWNobWVudHN9IG9uQ2hhbmdlPXtzZXRBdHRhY2htZW50c30gY29tcGFjdCAvPgogICAgICAgICAgPC9kaXY+CgogICAgICAgICAgey8qIFByaW9yaXR5IC8gQXNzaWduIC8gRHVlICovfQogICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImdyaWQgZ3JpZC1jb2xzLTMgZ2FwLTQiPgogICAgICAgICAgICA8ZGl2PgogICAgICAgICAgICAgIDxsYWJlbCBjbGFzc05hbWU9ImJsb2NrIHRleHQtc20gZm9udC1tZWRpdW0gbWItMS41Ij5Qcmlvcml0eTwvbGFiZWw+CiAgICAgICAgICAgICAgPHNlbGVjdCBjbGFzc05hbWU9InctZnVsbCBoLTEwIHB4LTMgcm91bmRlZC1sZyBiZy1zZWNvbmRhcnkgYm9yZGVyIGJvcmRlci1ib3JkZXIgdGV4dC1zbSIgdmFsdWU9e2Zvcm0ucHJpb3JpdHl9IG9uQ2hhbmdlPXsoZSkgPT4gc2V0Rm9ybSh7IC4uLmZvcm0sIHByaW9yaXR5OiBlLnRhcmdldC52YWx1ZSB9KX0+CiAgICAgICAgICAgICAgICB7WydMT1cnLCAnTk9STUFMJywgJ0hJR0gnLCAnVVJHRU5UJ10ubWFwKHAgPT4gPG9wdGlvbiBrZXk9e3B9IHZhbHVlPXtwfT57cH08L29wdGlvbj4pfQogICAgICAgICAgICAgIDwvc2VsZWN0PgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdj4KICAgICAgICAgICAgICA8bGFiZWwgY2xhc3NOYW1lPSJibG9jayB0ZXh0LXNtIGZvbnQtbWVkaXVtIG1iLTEuNSI+QXNzaWduIHRvPC9sYWJlbD4KICAgICAgICAgICAgICA8c2VsZWN0IGNsYXNzTmFtZT0idy1mdWxsIGgtMTAgcHgtMyByb3VuZGVkLWxnIGJnLXNlY29uZGFyeSBib3JkZXIgYm9yZGVyLWJvcmRlciB0ZXh0LXNtIiB2YWx1ZT17Zm9ybS5hc3NpZ25lZFRvSWR9IG9uQ2hhbmdlPXsoZSkgPT4gc2V0Rm9ybSh7IC4uLmZvcm0sIGFzc2lnbmVkVG9JZDogZS50YXJnZXQudmFsdWUgfSl9PgogICAgICAgICAgICAgICAgPG9wdGlvbiB2YWx1ZT0iIj5VbmFzc2lnbmVkPC9vcHRpb24+CiAgICAgICAgICAgICAgICB7dXNlcnMuZmlsdGVyKCh1OiBhbnkpID0+IHUuZGVwYXJ0bWVudElkID09PSBmb3JtLnRvRGVwYXJ0bWVudElkKS5tYXAoKHU6IGFueSkgPT4gKAogICAgICAgICAgICAgICAgICA8b3B0aW9uIGtleT17dS5pZH0gdmFsdWU9e3UuaWR9Pnt1LmZpcnN0TmFtZX0ge3UubGFzdE5hbWV9PC9vcHRpb24+CiAgICAgICAgICAgICAgICApKX0KICAgICAgICAgICAgICA8L3NlbGVjdD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgIDxkaXY+CiAgICAgICAgICAgICAgPGxhYmVsIGNsYXNzTmFtZT0iYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSBtYi0xLjUiPkR1ZSBkYXRlPC9sYWJlbD4KICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0iZGF0ZSIgY2xhc3NOYW1lPSJ3LWZ1bGwgaC0xMCBweC0zIHJvdW5kZWQtbGcgYmctc2Vjb25kYXJ5IGJvcmRlciBib3JkZXItYm9yZGVyIHRleHQtc20iIHZhbHVlPXtmb3JtLmR1ZURhdGV9IG9uQ2hhbmdlPXsoZSkgPT4gc2V0Rm9ybSh7IC4uLmZvcm0sIGR1ZURhdGU6IGUudGFyZ2V0LnZhbHVlIH0pfSAvPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgIDwvZGl2PgoKICAgICAgICAgIHsvKiBDQyAvIFdhdGNoZXJzICovfQogICAgICAgICAgPGRpdj4KICAgICAgICAgICAgPGxhYmVsIGNsYXNzTmFtZT0iYmxvY2sgdGV4dC1zbSBmb250LW1lZGl1bSBtYi0xLjUiPkNDIC8gV2F0Y2hlcnM8L2xhYmVsPgogICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iYm9yZGVyIGJvcmRlci1ib3JkZXIgcm91bmRlZC1sZyBiZy1zZWNvbmRhcnkgcC0yIG1pbi1oLVs0MnB4XSI+CiAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXggZmxleC13cmFwIGdhcC0xLjUgbWItMS41Ij4KICAgICAgICAgICAgICAgIHtjY1VzZXJJZHMubWFwKCh1aWQpID0+IHsKICAgICAgICAgICAgICAgICAgY29uc3QgdSA9IHVzZXJzLmZpbmQoKHg6IGFueSkgPT4geC5pZCA9PT0gdWlkKTsKICAgICAgICAgICAgICAgICAgaWYgKCF1KSByZXR1cm4gbnVsbDsKICAgICAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgICAgICA8c3BhbiBrZXk9e3VpZH0gY2xhc3NOYW1lPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMSBiZy1wcmltYXJ5LzEwIHRleHQtcHJpbWFyeSBweC0yIHB5LTEgcm91bmRlZC1tZCB0ZXh0LXhzIGZvbnQtbWVkaXVtIj4KICAgICAgICAgICAgICAgICAgICAgIHt1LmZpcnN0TmFtZX0ge3UubGFzdE5hbWV9CiAgICAgICAgICAgICAgICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgb25DbGljaz17KCkgPT4gc2V0Q2NVc2VySWRzKGNjVXNlcklkcy5maWx0ZXIoeCA9PiB4ICE9PSB1aWQpKX0gY2xhc3NOYW1lPSJob3Zlcjp0ZXh0LWRlc3RydWN0aXZlIj4KICAgICAgICAgICAgICAgICAgICAgICAgPFggc2l6ZT17MTB9IC8+CiAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICA8L3NwYW4+CiAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KX0KICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICA8c2VsZWN0CiAgICAgICAgICAgICAgICBjbGFzc05hbWU9InctZnVsbCBoLTggcHgtMiByb3VuZGVkIGJnLXRyYW5zcGFyZW50IGJvcmRlci0wIHRleHQteHMgZm9jdXM6b3V0bGluZS1ub25lIgogICAgICAgICAgICAgICAgdmFsdWU9IiIKICAgICAgICAgICAgICAgIG9uQ2hhbmdlPXsoZSkgPT4gewogICAgICAgICAgICAgICAgICBpZiAoZS50YXJnZXQudmFsdWUgJiYgIWNjVXNlcklkcy5pbmNsdWRlcyhlLnRhcmdldC52YWx1ZSkpIHsKICAgICAgICAgICAgICAgICAgICBzZXRDY1VzZXJJZHMoWy4uLmNjVXNlcklkcywgZS50YXJnZXQudmFsdWVdKTsKICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICBlLnRhcmdldC52YWx1ZSA9ICcnOwogICAgICAgICAgICAgICAgfX0KICAgICAgICAgICAgICA+CiAgICAgICAgICAgICAgICA8b3B0aW9uIHZhbHVlPSIiPkFkZCBhIHdhdGNoZXIuLi48L29wdGlvbj4KICAgICAgICAgICAgICAgIHt1c2Vycy5maWx0ZXIoKHU6IGFueSkgPT4gIWNjVXNlcklkcy5pbmNsdWRlcyh1LmlkKSkubWFwKCh1OiBhbnkpID0+ICgKICAgICAgICAgICAgICAgICAgPG9wdGlvbiBrZXk9e3UuaWR9IHZhbHVlPXt1LmlkfT57dS5maXJzdE5hbWV9IHt1Lmxhc3ROYW1lfSAoe3UuZGVwYXJ0bWVudD8ubmFtZSB8fCAnTm8gZGVwdCd9KTwvb3B0aW9uPgogICAgICAgICAgICAgICAgKSl9CiAgICAgICAgICAgICAgPC9zZWxlY3Q+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICA8cCBjbGFzc05hbWU9InRleHQtWzEwcHhdIHRleHQtbXV0ZWQtZm9yZWdyb3VuZCBtdC0xIj5XYXRjaGVycyB3aWxsIHJlY2VpdmUgbm90aWZpY2F0aW9ucyBmb3IgYWxsIHVwZGF0ZXMgb24gdGhpcyB0aWNrZXQ8L3A+CiAgICAgICAgICA8L2Rpdj4KCiAgICAgICAgICB7ZXJyb3IgJiYgPHAgY2xhc3NOYW1lPSJ0ZXh0LXNtIHRleHQtZGVzdHJ1Y3RpdmUgYmctZGVzdHJ1Y3RpdmUvMTAgcHgtNCBweS0yLjUgcm91bmRlZC14bCI+e2Vycm9yfTwvcD59CgogICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXgganVzdGlmeS1lbmQgZ2FwLTMgcHQtMiBib3JkZXItdCBib3JkZXItYm9yZGVyIj4KICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJidXR0b24iIG9uQ2xpY2s9e29uQ2xvc2V9IGNsYXNzTmFtZT0icHgtNCBoLTEwIHJvdW5kZWQteGwgdGV4dC1zbSBmb250LW1lZGl1bSBob3ZlcjpiZy1hY2NlbnQgdHJhbnNpdGlvbi1jb2xvcnMiPkNhbmNlbDwvYnV0dG9uPgogICAgICAgICAgICA8YnV0dG9uIHR5cGU9ImJ1dHRvbiIgZGlzYWJsZWQ9e2xvYWRpbmd9IG9uQ2xpY2s9eygpID0+IGRvU3VibWl0KHRydWUpfQogICAgICAgICAgICAgIGNsYXNzTmFtZT0icHgtNSBoLTEwIGJnLXNlY29uZGFyeSB0ZXh0LWZvcmVncm91bmQgYm9yZGVyIGJvcmRlci1ib3JkZXIgcm91bmRlZC14bCB0ZXh0LXNtIGZvbnQtbWVkaXVtIGhvdmVyOmJnLWFjY2VudCBkaXNhYmxlZDpvcGFjaXR5LTUwIGZsZXggaXRlbXMtY2VudGVyIGdhcC0yIHRyYW5zaXRpb24tYWxsIj4KICAgICAgICAgICAgICB7bG9hZGluZyAmJiA8TG9hZGVyMiBjbGFzc05hbWU9ImFuaW1hdGUtc3BpbiIgc2l6ZT17MTR9IC8+fQogICAgICAgICAgICAgIFNhdmUgYXMgRHJhZnQKICAgICAgICAgICAgPC9idXR0b24+CiAgICAgICAgICAgIDxidXR0b24gdHlwZT0ic3VibWl0IiBkaXNhYmxlZD17bG9hZGluZ30gY2xhc3NOYW1lPSJweC02IGgtMTAgYmctcHJpbWFyeSB0ZXh0LXByaW1hcnktZm9yZWdyb3VuZCByb3VuZGVkLXhsIHRleHQtc20gZm9udC1tZWRpdW0gaG92ZXI6b3BhY2l0eS05MCBkaXNhYmxlZDpvcGFjaXR5LTUwIGZsZXggaXRlbXMtY2VudGVyIGdhcC0yIHRyYW5zaXRpb24tYWxsIj4KICAgICAgICAgICAgICB7bG9hZGluZyAmJiA8TG9hZGVyMiBjbGFzc05hbWU9ImFuaW1hdGUtc3BpbiIgc2l6ZT17MTR9IC8+fQogICAgICAgICAgICAgIENyZWF0ZSBSZXF1ZXN0CiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9mb3JtPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogICk7Cn0KCi8qID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PSBUSUNLRVRTIExJU1QgPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09ICovCmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIFRpY2tldHNQYWdlKCkgewogIGNvbnN0IHNlYXJjaFBhcmFtcyA9IHVzZVNlYXJjaFBhcmFtcygpOwogIGNvbnN0IHsgdXNlciB9ID0gdXNlQXV0aFN0b3JlKCk7CiAgY29uc3QgeyBmZXRjaFVucmVhZFRpY2tldElkcywgdW5yZWFkVGlja2V0SWRzIH0gPSB1c2VOb3RpZmljYXRpb25TdG9yZSgpOwogIGNvbnN0IFt0aWNrZXRzLCBzZXRUaWNrZXRzXSA9IHVzZVN0YXRlPGFueVtdPihbXSk7CiAgY29uc3QgW3RvdGFsLCBzZXRUb3RhbF0gPSB1c2VTdGF0ZSgwKTsKICBjb25zdCBbbG9hZGluZywgc2V0TG9hZGluZ10gPSB1c2VTdGF0ZSh0cnVlKTsKICBjb25zdCBbcGFnZSwgc2V0UGFnZV0gPSB1c2VTdGF0ZSgxKTsKICBjb25zdCBbZmlsdGVycywgc2V0RmlsdGVyc10gPSB1c2VTdGF0ZSh7IHN0YXR1czogJycsIHByaW9yaXR5OiAnJywgc2VhcmNoOiAnJyB9KTsKICBjb25zdCBbc2hvd0NyZWF0ZSwgc2V0U2hvd0NyZWF0ZV0gPSB1c2VTdGF0ZShzZWFyY2hQYXJhbXMuZ2V0KCduZXcnKSA9PT0gJ3RydWUnKTsKICBjb25zdCBpc0RlcHRIZWFkID0gdXNlcj8uZGVwYXJ0bWVudFJvbGUgPT09ICdERVBBUlRNRU5UX0hFQUQnIHx8IHVzZXI/Lmdsb2JhbFJvbGUgPT09ICdHTE9CQUxfQURNSU4nOwogIGNvbnN0IFt2aWV3LCBzZXRWaWV3XSA9IHVzZVN0YXRlPCdwZXJzb25hbCcgfCAnZGVwYXJ0bWVudCcgfCAnZHJhZnRzJz4oJ3BlcnNvbmFsJyk7CiAgY29uc3QgW3Nob3dUb2dnbGUsIHNldFNob3dUb2dnbGVdID0gdXNlU3RhdGUoZmFsc2UpOwoKICAvLyBVcGRhdGUgdG9nZ2xlIHZpc2liaWxpdHkgd2hlbiB1c2VyIGxvYWRzCiAgdXNlRWZmZWN0KCgpID0+IHsKICAgIGlmICh1c2VyKSB7CiAgICAgIHNldFNob3dUb2dnbGUodXNlci5kZXBhcnRtZW50Um9sZSA9PT0gJ0RFUEFSVE1FTlRfSEVBRCcgfHwgdXNlci5nbG9iYWxSb2xlID09PSAnR0xPQkFMX0FETUlOJyk7CiAgICB9CiAgfSwgW3VzZXJdKTsKCiAgLy8gRW5zdXJlIHVucmVhZCB0aWNrZXQgSURzIGFyZSBsb2FkZWQKICB1c2VFZmZlY3QoKCkgPT4geyBmZXRjaFVucmVhZFRpY2tldElkcygpOyB9LCBbZmV0Y2hVbnJlYWRUaWNrZXRJZHNdKTsKCiAgY29uc3QgZmV0Y2hUaWNrZXRzID0gdXNlQ2FsbGJhY2soYXN5bmMgKCkgPT4gewogICAgc2V0TG9hZGluZyh0cnVlKTsKICAgIHRyeSB7CiAgICAgIGNvbnN0IHBhcmFtczogYW55ID0geyBwYWdlOiBTdHJpbmcocGFnZSksIGxpbWl0OiAnMjUnIH07CiAgICAgIGlmIChmaWx0ZXJzLnN0YXR1cykgcGFyYW1zLnN0YXR1cyA9IGZpbHRlcnMuc3RhdHVzOwogICAgICBpZiAoZmlsdGVycy5wcmlvcml0eSkgcGFyYW1zLnByaW9yaXR5ID0gZmlsdGVycy5wcmlvcml0eTsKICAgICAgaWYgKGZpbHRlcnMuc2VhcmNoKSBwYXJhbXMuc2VhcmNoID0gZmlsdGVycy5zZWFyY2g7CiAgICAgIHBhcmFtcy52aWV3ID0gdmlldzsKICAgICAgaWYgKHZpZXcgPT09ICdkcmFmdHMnKSBwYXJhbXMuc3RhdHVzID0gJ0RSQUZUJzsKICAgICAgY29uc3QgZGF0YSA9IGF3YWl0IGFwaS5nZXRUaWNrZXRzKHBhcmFtcyk7CiAgICAgIHNldFRpY2tldHMoZGF0YS5kYXRhKTsgc2V0VG90YWwoZGF0YS50b3RhbCk7CiAgICB9IGZpbmFsbHkgeyBzZXRMb2FkaW5nKGZhbHNlKTsgfQogIH0sIFtwYWdlLCBmaWx0ZXJzLCB2aWV3XSk7CgogIHVzZUVmZmVjdCgoKSA9PiB7IGZldGNoVGlja2V0cygpOyB9LCBbZmV0Y2hUaWNrZXRzXSk7CgogIC8vIFJlc2V0IHBhZ2Ugd2hlbiBzd2l0Y2hpbmcgdmlld3MKICBjb25zdCBzd2l0Y2hWaWV3ID0gKHY6ICdwZXJzb25hbCcgfCAnZGVwYXJ0bWVudCcgfCAnZHJhZnRzJykgPT4gewogICAgc2V0Vmlldyh2KTsKICAgIHNldFBhZ2UoMSk7CiAgfTsKCiAgY29uc3QgZ2V0U2xhU3RhdHVzID0gKHRpY2tldDogYW55KSA9PiB7CiAgICBpZiAoWydDTE9TRUQnLCAnUkVKRUNURUQnXS5pbmNsdWRlcyh0aWNrZXQuc3RhdHVzKSkgcmV0dXJuIG51bGw7CiAgICBjb25zdCBkZWFkbGluZSA9IHRpY2tldC5zbGFSZXNvbHV0aW9uRGVhZGxpbmUgPyBuZXcgRGF0ZSh0aWNrZXQuc2xhUmVzb2x1dGlvbkRlYWRsaW5lKSA6IG51bGw7CiAgICBpZiAoIWRlYWRsaW5lKSByZXR1cm4gbnVsbDsKICAgIGNvbnN0IGhvdXJzTGVmdCA9IChkZWFkbGluZS5nZXRUaW1lKCkgLSBEYXRlLm5vdygpKSAvIDM2MDAwMDA7CiAgICBpZiAoaG91cnNMZWZ0IDwgMCkgcmV0dXJuICdyZWQnOwogICAgaWYgKGhvdXJzTGVmdCA8IDgpIHJldHVybiAneWVsbG93JzsKICAgIHJldHVybiAnZ3JlZW4nOwogIH07CgogIHJldHVybiAoCiAgICA8ZGl2IGNsYXNzTmFtZT0ic3BhY2UteS00Ij4KICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXggaXRlbXMtY2VudGVyIGp1c3RpZnktYmV0d2VlbiI+CiAgICAgICAgPGRpdj4KICAgICAgICAgIDxoMSBjbGFzc05hbWU9InRleHQtMnhsIGZvbnQtYm9sZCI+VGlja2V0czwvaDE+CiAgICAgICAgICA8cCBjbGFzc05hbWU9InRleHQtc20gdGV4dC1tdXRlZC1mb3JlZ3JvdW5kIj57dG90YWx9IHRvdGFsPC9wPgogICAgICAgIDwvZGl2PgogICAgICAgIDxidXR0b24gb25DbGljaz17KCkgPT4gc2V0U2hvd0NyZWF0ZSh0cnVlKX0gY2xhc3NOYW1lPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMiBoLTEwIHB4LTUgYmctcHJpbWFyeSB0ZXh0LXByaW1hcnktZm9yZWdyb3VuZCByb3VuZGVkLXhsIHRleHQtc20gZm9udC1tZWRpdW0gaG92ZXI6b3BhY2l0eS05MCI+CiAgICAgICAgICA8UGx1cyBzaXplPXsxNn0gLz4gTmV3IFJlcXVlc3QKICAgICAgICA8L2J1dHRvbj4KICAgICAgPC9kaXY+CgogICAgICB7LyogVmlldyB0YWJzIOKAlCBhbHdheXMgc2hvdyBNeSBUaWNrZXRzICsgRHJhZnRzOyBkZXB0IGhlYWRzIGFsc28gZ2V0IERlcGFydG1lbnQgKi99CiAgICAgIDxkaXYgY2xhc3NOYW1lPSJmbGV4IGdhcC0xIGJnLXNlY29uZGFyeSByb3VuZGVkLXhsIHAtMSB3LWZpdCI+CiAgICAgICAgPGJ1dHRvbgogICAgICAgICAgb25DbGljaz17KCkgPT4gc3dpdGNoVmlldygncGVyc29uYWwnKX0KICAgICAgICAgIGNsYXNzTmFtZT17YGZsZXggaXRlbXMtY2VudGVyIGdhcC0yIHB4LTQgcHktMiByb3VuZGVkLWxnIHRleHQtc20gZm9udC1tZWRpdW0gdHJhbnNpdGlvbi1hbGwgJHsKICAgICAgICAgICAgdmlldyA9PT0gJ3BlcnNvbmFsJyA/ICdiZy1jYXJkIHNoYWRvdyB0ZXh0LWZvcmVncm91bmQnIDogJ3RleHQtbXV0ZWQtZm9yZWdyb3VuZCBob3Zlcjp0ZXh0LWZvcmVncm91bmQnCiAgICAgICAgICB9YH0KICAgICAgICA+CiAgICAgICAgICA8VXNlciBzaXplPXsxNX0gLz4gTXkgVGlja2V0cwogICAgICAgIDwvYnV0dG9uPgogICAgICAgIHtzaG93VG9nZ2xlICYmICgKICAgICAgICAgIDxidXR0b24KICAgICAgICAgICAgb25DbGljaz17KCkgPT4gc3dpdGNoVmlldygnZGVwYXJ0bWVudCcpfQogICAgICAgICAgICBjbGFzc05hbWU9e2BmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMiBweC00IHB5LTIgcm91bmRlZC1sZyB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRyYW5zaXRpb24tYWxsICR7CiAgICAgICAgICAgICAgdmlldyA9PT0gJ2RlcGFydG1lbnQnID8gJ2JnLWNhcmQgc2hhZG93IHRleHQtZm9yZWdyb3VuZCcgOiAndGV4dC1tdXRlZC1mb3JlZ3JvdW5kIGhvdmVyOnRleHQtZm9yZWdyb3VuZCcKICAgICAgICAgICAgfWB9CiAgICAgICAgICA+CiAgICAgICAgICAgIDxCdWlsZGluZzIgc2l6ZT17MTV9IC8+IERlcGFydG1lbnQKICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICl9CiAgICAgICAgPGJ1dHRvbgogICAgICAgICAgb25DbGljaz17KCkgPT4gc3dpdGNoVmlldygnZHJhZnRzJyl9CiAgICAgICAgICBjbGFzc05hbWU9e2BmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMiBweC00IHB5LTIgcm91bmRlZC1sZyB0ZXh0LXNtIGZvbnQtbWVkaXVtIHRyYW5zaXRpb24tYWxsICR7CiAgICAgICAgICAgIHZpZXcgPT09ICdkcmFmdHMnID8gJ2JnLWNhcmQgc2hhZG93IHRleHQtZm9yZWdyb3VuZCcgOiAndGV4dC1tdXRlZC1mb3JlZ3JvdW5kIGhvdmVyOnRleHQtZm9yZWdyb3VuZCcKICAgICAgICAgIH1gfQogICAgICAgID4KICAgICAgICAgIDxQZW5TcXVhcmUgc2l6ZT17MTV9IC8+IERyYWZ0cwogICAgICAgIDwvYnV0dG9uPgogICAgICA8L2Rpdj4KCiAgICAgIHsvKiBGaWx0ZXJzICovfQogICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTMgZmxleC13cmFwIj4KICAgICAgICA8aW5wdXQgcGxhY2Vob2xkZXI9IlNlYXJjaCB0aWNrZXRzLi4uIiB2YWx1ZT17ZmlsdGVycy5zZWFyY2h9IG9uQ2hhbmdlPXsoZSkgPT4gc2V0RmlsdGVycyh7IC4uLmZpbHRlcnMsIHNlYXJjaDogZS50YXJnZXQudmFsdWUgfSl9CiAgICAgICAgICBjbGFzc05hbWU9ImZsZXgtMSBtYXgtdy1zbSBoLTEwIHB4LTQgcm91bmRlZC14bCBiZy1jYXJkIGJvcmRlciBib3JkZXItYm9yZGVyIHRleHQtc20iIC8+CiAgICAgICAgPHNlbGVjdCB2YWx1ZT17ZmlsdGVycy5zdGF0dXN9IG9uQ2hhbmdlPXsoZSkgPT4gc2V0RmlsdGVycyh7IC4uLmZpbHRlcnMsIHN0YXR1czogZS50YXJnZXQudmFsdWUgfSl9IGNsYXNzTmFtZT0iaC0xMCBweC0zIHJvdW5kZWQteGwgYmctY2FyZCBib3JkZXIgYm9yZGVyLWJvcmRlciB0ZXh0LXNtIj4KICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+QWxsIFN0YXR1czwvb3B0aW9uPgogICAgICAgICAge1snRFJBRlQnLCAnT1BFTicsICdJTl9QUk9HUkVTUycsICdXQUlUSU5HX1JFUExZJywgJ0FQUFJPVkVEJywgJ1JFSkVDVEVEJywgJ0NMT1NFRCddLm1hcChzID0+IDxvcHRpb24ga2V5PXtzfSB2YWx1ZT17c30+e3MucmVwbGFjZSgnXycsICcgJyl9PC9vcHRpb24+KX0KICAgICAgICA8L3NlbGVjdD4KICAgICAgICA8c2VsZWN0IHZhbHVlPXtmaWx0ZXJzLnByaW9yaXR5fSBvbkNoYW5nZT17KGUpID0+IHNldEZpbHRlcnMoeyAuLi5maWx0ZXJzLCBwcmlvcml0eTogZS50YXJnZXQudmFsdWUgfSl9IGNsYXNzTmFtZT0iaC0xMCBweC0zIHJvdW5kZWQteGwgYmctY2FyZCBib3JkZXIgYm9yZGVyLWJvcmRlciB0ZXh0LXNtIj4KICAgICAgICAgIDxvcHRpb24gdmFsdWU9IiI+QWxsIFByaW9yaXR5PC9vcHRpb24+CiAgICAgICAgICB7WydMT1cnLCAnTk9STUFMJywgJ0hJR0gnLCAnVVJHRU5UJ10ubWFwKHAgPT4gPG9wdGlvbiBrZXk9e3B9IHZhbHVlPXtwfT57cH08L29wdGlvbj4pfQogICAgICAgIDwvc2VsZWN0PgogICAgICA8L2Rpdj4KCiAgICAgIHsvKiBUaWNrZXQgbGlzdCAqL30KICAgICAgPGRpdiBjbGFzc05hbWU9ImJnLWNhcmQgYm9yZGVyIGJvcmRlci1ib3JkZXIgcm91bmRlZC0yeGwgb3ZlcmZsb3ctaGlkZGVuIj4KICAgICAgICB7bG9hZGluZyA/ICgKICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJmbGV4IGl0ZW1zLWNlbnRlciBqdXN0aWZ5LWNlbnRlciBoLTMyIj48TG9hZGVyMiBjbGFzc05hbWU9ImFuaW1hdGUtc3BpbiB0ZXh0LXByaW1hcnkiIHNpemU9ezIwfSAvPjwvZGl2PgogICAgICAgICkgOiB0aWNrZXRzLmxlbmd0aCA9PT0gMCA/ICgKICAgICAgICAgIDxwIGNsYXNzTmFtZT0icC04IHRleHQtY2VudGVyIHRleHQtbXV0ZWQtZm9yZWdyb3VuZCB0ZXh0LXNtIj5ObyB0aWNrZXRzIGZvdW5kPC9wPgogICAgICAgICkgOiAoCiAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iZGl2aWRlLXkgZGl2aWRlLWJvcmRlciI+CiAgICAgICAgICAgIHt0aWNrZXRzLm1hcCgodGlja2V0KSA9PiB7CiAgICAgICAgICAgICAgY29uc3Qgc2xhID0gZ2V0U2xhU3RhdHVzKHRpY2tldCk7CiAgICAgICAgICAgICAgY29uc3QgaGFzVW5yZWFkID0gdW5yZWFkVGlja2V0SWRzLmluY2x1ZGVzKHRpY2tldC5pZCk7CiAgICAgICAgICAgICAgcmV0dXJuICgKICAgICAgICAgICAgICAgIDxMaW5rIGtleT17dGlja2V0LmlkfSBocmVmPXtgL2Rhc2hib2FyZC90aWNrZXRzLyR7dGlja2V0LmlkfWB9CiAgICAgICAgICAgICAgICAgIGNsYXNzTmFtZT17YGZsZXggaXRlbXMtY2VudGVyIGdhcC0zIHAtNCBob3ZlcjpiZy1hY2NlbnQvNTAgdHJhbnNpdGlvbi1hbGwgZ3JvdXAgcmVsYXRpdmUKICAgICAgICAgICAgICAgICAgICAke2hhc1VucmVhZCA/ICdiZy1wcmltYXJ5L1swLjA2XSBib3JkZXItbC1bM3B4XSBib3JkZXItbC1wcmltYXJ5JyA6ICdib3JkZXItbC1bM3B4XSBib3JkZXItbC10cmFuc3BhcmVudCd9YH0KICAgICAgICAgICAgICAgID4KICAgICAgICAgICAgICAgICAgey8qIFVucmVhZCBwdWxzaW5nIGRvdCAqL30KICAgICAgICAgICAgICAgICAge2hhc1VucmVhZCA/ICgKICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0icmVsYXRpdmUgc2hyaW5rLTAiPgogICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9InctMi41IGgtMi41IHJvdW5kZWQtZnVsbCBiZy1wcmltYXJ5IiAvPgogICAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImFic29sdXRlIGluc2V0LTAgdy0yLjUgaC0yLjUgcm91bmRlZC1mdWxsIGJnLXByaW1hcnkgYW5pbWF0ZS1waW5nIG9wYWNpdHktNDAiIC8+CiAgICAgICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICAgICkgOiAoCiAgICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9e2B3LTIuNSBoLTIuNSByb3VuZGVkLWZ1bGwgc2hyaW5rLTAgJHtwcmlvcml0eURvdHNbdGlja2V0LnByaW9yaXR5XX1gfSAvPgogICAgICAgICAgICAgICAgICApfQogICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleC0xIG1pbi13LTAiPgogICAgICAgICAgICAgICAgICAgIDxkaXYgY2xhc3NOYW1lPSJmbGV4IGl0ZW1zLWNlbnRlciBnYXAtMiBtYi0wLjUiPgogICAgICAgICAgICAgICAgICAgICAge2hhc1VucmVhZCAmJiAoCiAgICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTEgcHgtMS41IHB5LTAuNSBiZy1wcmltYXJ5LzE1IHRleHQtcHJpbWFyeSByb3VuZGVkIHRleHQtWzEwcHhdIGZvbnQtc2VtaWJvbGQiPgogICAgICAgICAgICAgICAgICAgICAgICAgIDxCZWxsIHNpemU9ezEwfSBjbGFzc05hbWU9ImZpbGwtcHJpbWFyeSIgLz4gTkVXCiAgICAgICAgICAgICAgICAgICAgICAgIDwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgICl9CiAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9ImZvbnQtbW9ubyB0ZXh0LXhzIHRleHQtbXV0ZWQtZm9yZWdyb3VuZCI+e3RpY2tldC50aWNrZXROdW1iZXJ9PC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPXtgcHgtMS41IHB5LTAuNSByb3VuZGVkIHRleHQtWzEwcHhdIGZvbnQtbWVkaXVtIGJvcmRlciAke3N0YXR1c0NvbG9yc1t0aWNrZXQuc3RhdHVzXX1gfT57dGlja2V0LnN0YXR1cy5yZXBsYWNlKCdfJywgJyAnKX08L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICB7c2xhID09PSAncmVkJyAmJiA8QWxlcnRUcmlhbmdsZSBzaXplPXsxMn0gY2xhc3NOYW1lPSJ0ZXh0LXJlZC00MDAgYW5pbWF0ZS1wdWxzZSIgLz59CiAgICAgICAgICAgICAgICAgICAgICB7c2xhID09PSAneWVsbG93JyAmJiA8Q2xvY2sgc2l6ZT17MTJ9IGNsYXNzTmFtZT0idGV4dC1hbWJlci00MDAiIC8+fQogICAgICAgICAgICAgICAgICAgICAge3RpY2tldC5zdWJ0eXBlICYmIDxzcGFuIGNsYXNzTmFtZT0idGV4dC1bMTBweF0gdGV4dC1tdXRlZC1mb3JlZ3JvdW5kIGJnLXNlY29uZGFyeSBweC0xLjUgcHktMC41IHJvdW5kZWQiPnt0aWNrZXQuc3VidHlwZS5jYXRlZ29yeT8ubmFtZX0gLyB7dGlja2V0LnN1YnR5cGUubmFtZX08L3NwYW4+fQogICAgICAgICAgICAgICAgICAgICAge3RpY2tldC5tZXRhZGF0YT8uZW50aXR5VHlwZSAmJiB0aWNrZXQubWV0YWRhdGEuZW50aXR5VHlwZSAhPT0gJ25vbmUnICYmICgKICAgICAgICAgICAgICAgICAgICAgICAgPHNwYW4gY2xhc3NOYW1lPXtgdGV4dC1bMTBweF0gcHgtMS41IHB5LTAuNSByb3VuZGVkIGZvbnQtbWVkaXVtICR7dGlja2V0Lm1ldGFkYXRhLmVudGl0eVR5cGUgPT09ICdjbGllbnQnID8gJ2JnLWJsdWUtNTAwLzEwIHRleHQtYmx1ZS01MDAnIDogJ2JnLWVtZXJhbGQtNTAwLzEwIHRleHQtZW1lcmFsZC01MDAnfWB9PgogICAgICAgICAgICAgICAgICAgICAgICAgIHt0aWNrZXQubWV0YWRhdGEuZW50aXR5VHlwZSA9PT0gJ2NsaWVudCcgPyAn8J+RpCcgOiAn8J+amid9IHt0aWNrZXQubWV0YWRhdGEuZW50aXR5TmFtZSB8fCB0aWNrZXQubWV0YWRhdGEuZW50aXR5VHlwZX0KICAgICAgICAgICAgICAgICAgICAgICAgPC9zcGFuPgogICAgICAgICAgICAgICAgICAgICAgKX0KICAgICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgICA8cCBjbGFzc05hbWU9e2B0ZXh0LXNtIHRydW5jYXRlIGdyb3VwLWhvdmVyOnRleHQtcHJpbWFyeSB0cmFuc2l0aW9uLWNvbG9ycyAke2hhc1VucmVhZCA/ICdmb250LXNlbWlib2xkIHRleHQtZm9yZWdyb3VuZCcgOiAnZm9udC1tZWRpdW0nfWB9Pnt0aWNrZXQudGl0bGV9PC9wPgogICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXggaXRlbXMtY2VudGVyIGdhcC00IHNocmluay0wIHRleHQteHMgdGV4dC1tdXRlZC1mb3JlZ3JvdW5kIj4KICAgICAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCBpdGVtcy1jZW50ZXIgZ2FwLTEuNSI+CiAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9InctMiBoLTIgcm91bmRlZC1mdWxsIiBzdHlsZT17eyBiYWNrZ3JvdW5kQ29sb3I6IHRpY2tldC5mcm9tRGVwYXJ0bWVudD8uY29sb3IgfX0gLz4KICAgICAgICAgICAgICAgICAgICAgIHt0aWNrZXQuZnJvbURlcGFydG1lbnQ/Lm5hbWV9CiAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9Im14LTEiPuKGkjwvc3Bhbj4KICAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzTmFtZT0idy0yIGgtMiByb3VuZGVkLWZ1bGwiIHN0eWxlPXt7IGJhY2tncm91bmRDb2xvcjogdGlja2V0LnRvRGVwYXJ0bWVudD8uY29sb3IgfX0gLz4KICAgICAgICAgICAgICAgICAgICAgIHt0aWNrZXQudG9EZXBhcnRtZW50Py5uYW1lfQogICAgICAgICAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgICAgICAgICAgIHt0aWNrZXQuYXNzaWduZWRUbyAmJiA8c3Bhbj57dGlja2V0LmFzc2lnbmVkVG8uZmlyc3ROYW1lfSB7dGlja2V0LmFzc2lnbmVkVG8ubGFzdE5hbWU/LlswXX0uPC9zcGFuPn0KICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzc05hbWU9InRleHQtWzEwcHhdIj57bmV3IERhdGUodGlja2V0LmNyZWF0ZWRBdCkudG9Mb2NhbGVEYXRlU3RyaW5nKCl9PC9zcGFuPgogICAgICAgICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgICAgIDwvTGluaz4KICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KX0KICAgICAgICAgIDwvZGl2PgogICAgICAgICl9CiAgICAgICAge3RvdGFsID4gMjUgJiYgKAogICAgICAgICAgPGRpdiBjbGFzc05hbWU9ImZsZXggaXRlbXMtY2VudGVyIGp1c3RpZnktYmV0d2VlbiBweC00IHB5LTMgYm9yZGVyLXQgYm9yZGVyLWJvcmRlciI+CiAgICAgICAgICAgIDxwIGNsYXNzTmFtZT0idGV4dC14cyB0ZXh0LW11dGVkLWZvcmVncm91bmQiPlBhZ2Uge3BhZ2V9IG9mIHtNYXRoLmNlaWwodG90YWwgLyAyNSl9PC9wPgogICAgICAgICAgICA8ZGl2IGNsYXNzTmFtZT0iZmxleCBnYXAtMSI+CiAgICAgICAgICAgICAgPGJ1dHRvbiBvbkNsaWNrPXsoKSA9PiBzZXRQYWdlKHAgPT4gTWF0aC5tYXgoMSwgcCAtIDEpKX0gZGlzYWJsZWQ9e3BhZ2UgPT09IDF9IGNsYXNzTmFtZT0icC0xLjUgcm91bmRlZC1sZyBob3ZlcjpiZy1hY2NlbnQgZGlzYWJsZWQ6b3BhY2l0eS0zMCI+PENoZXZyb25MZWZ0IHNpemU9ezE2fSAvPjwvYnV0dG9uPgogICAgICAgICAgICAgIDxidXR0b24gb25DbGljaz17KCkgPT4gc2V0UGFnZShwID0+IHAgKyAxKX0gZGlzYWJsZWQ9e3BhZ2UgPj0gTWF0aC5jZWlsKHRvdGFsIC8gMjUpfSBjbGFzc05hbWU9InAtMS41IHJvdW5kZWQtbGcgaG92ZXI6YmctYWNjZW50IGRpc2FibGVkOm9wYWNpdHktMzAiPjxDaGV2cm9uUmlnaHQgc2l6ZT17MTZ9IC8+PC9idXR0b24+CiAgICAgICAgICAgIDwvZGl2PgogICAgICAgICAgPC9kaXY+CiAgICAgICAgKX0KICAgICAgPC9kaXY+CgogICAgICA8Q3JlYXRlVGlja2V0TW9kYWwgb3Blbj17c2hvd0NyZWF0ZX0gb25DbG9zZT17KCkgPT4gc2V0U2hvd0NyZWF0ZShmYWxzZSl9IG9uQ3JlYXRlZD17ZmV0Y2hUaWNrZXRzfSAvPgogICAgPC9kaXY+CiAgKTsKfQo=' | base64 -d > frontend/src/app/dashboard/tickets/page.tsx
echo 'Patching tickets service...'
echo 'aW1wb3J0IHsKICBJbmplY3RhYmxlLAogIE5vdEZvdW5kRXhjZXB0aW9uLAogIEZvcmJpZGRlbkV4Y2VwdGlvbiwKfSBmcm9tICdAbmVzdGpzL2NvbW1vbic7CmltcG9ydCB7IFByaXNtYVNlcnZpY2UgfSBmcm9tICcuLi8uLi9wcmlzbWEvcHJpc21hLnNlcnZpY2UnOwppbXBvcnQgeyBOb3RpZmljYXRpb25zU2VydmljZSB9IGZyb20gJy4uL25vdGlmaWNhdGlvbnMvbm90aWZpY2F0aW9ucy5zZXJ2aWNlJzsKaW1wb3J0IHsgRmlsZXNTZXJ2aWNlIH0gZnJvbSAnLi4vZmlsZXMvZmlsZXMuc2VydmljZSc7CmltcG9ydCB7IFRpY2tldFN0YXR1cywgVGlja2V0UHJpb3JpdHkgfSBmcm9tICdAcHJpc21hL2NsaWVudCc7CgpASW5qZWN0YWJsZSgpCmV4cG9ydCBjbGFzcyBUaWNrZXRzU2VydmljZSB7CiAgY29uc3RydWN0b3IoCiAgICBwcml2YXRlIHByaXNtYTogUHJpc21hU2VydmljZSwKICAgIHByaXZhdGUgbm90aWZpY2F0aW9uczogTm90aWZpY2F0aW9uc1NlcnZpY2UsCiAgICBwcml2YXRlIGZpbGVzU2VydmljZTogRmlsZXNTZXJ2aWNlLAogICkge30KCiAgcHJpdmF0ZSBhc3luYyBjaGVja0FjY2Vzcyh0aWNrZXQ6IGFueSwgdXNlcjogYW55KSB7CiAgICBpZiAodXNlci5nbG9iYWxSb2xlID09PSAnR0xPQkFMX0FETUlOJykgcmV0dXJuOwogICAgLy8gRGVwYXJ0bWVudCBoZWFkcyBjYW4gc2VlIGFsbCB0aWNrZXRzIHRvL2Zyb20gdGhlaXIgZGVwYXJ0bWVudAogICAgaWYgKHVzZXIuZGVwYXJ0bWVudFJvbGUgPT09ICdERVBBUlRNRU5UX0hFQUQnICYmIAogICAgICAgICh0aWNrZXQudG9EZXBhcnRtZW50SWQgPT09IHVzZXIuZGVwYXJ0bWVudElkIHx8IHRpY2tldC5mcm9tRGVwYXJ0bWVudElkID09PSB1c2VyLmRlcGFydG1lbnRJZCkpIHJldHVybjsKICAgIC8vIFJlZ3VsYXIgdXNlcnM6IG9ubHkgY3JlYXRlZCwgYXNzaWduZWQsIG9yIHdhdGNoaW5nCiAgICBpZiAodGlja2V0LmNyZWF0ZWRCeUlkID09PSB1c2VyLmlkIHx8IHRpY2tldC5hc3NpZ25lZFRvSWQgPT09IHVzZXIuaWQpIHJldHVybjsKICAgIC8vIENoZWNrIGlmIHVzZXIgaXMgYSB3YXRjaGVyCiAgICBjb25zdCB3YXRjaGVyID0gYXdhaXQgdGhpcy5wcmlzbWEudGlja2V0V2F0Y2hlci5maW5kVW5pcXVlKHsKICAgICAgd2hlcmU6IHsgdGlja2V0SWRfdXNlcklkOiB7IHRpY2tldElkOiB0aWNrZXQuaWQsIHVzZXJJZDogdXNlci5pZCB9IH0sCiAgICB9KTsKICAgIGlmICh3YXRjaGVyKSByZXR1cm47CiAgICB0aHJvdyBuZXcgRm9yYmlkZGVuRXhjZXB0aW9uKCdBY2Nlc3MgZGVuaWVkJyk7CiAgfQoKICBhc3luYyBmaW5kQWxsKHVzZXI6IGFueSwgcGFyYW1zOiBhbnkpIHsKICAgIGNvbnN0IHsgcGFnZTogcmF3UGFnZSwgbGltaXQ6IHJhd0xpbWl0LCBzb3J0QnkgPSAnY3JlYXRlZEF0Jywgc29ydE9yZGVyID0gJ2Rlc2MnLCB2aWV3LCAuLi5maWx0ZXJzIH0gPSBwYXJhbXM7CiAgICBjb25zdCBwYWdlID0gcGFyc2VJbnQocmF3UGFnZSwgMTApIHx8IDE7CiAgICBjb25zdCBsaW1pdCA9IHBhcnNlSW50KHJhd0xpbWl0LCAxMCkgfHwgMjU7CiAgICBjb25zdCB3aGVyZTogYW55ID0ge307CiAgICBjb25zdCBpc0RlcHRIZWFkID0gdXNlci5kZXBhcnRtZW50Um9sZSA9PT0gJ0RFUEFSVE1FTlRfSEVBRCc7CgogICAgaWYgKHVzZXIuZ2xvYmFsUm9sZSAhPT0gJ0dMT0JBTF9BRE1JTicpIHsKICAgICAgaWYgKHZpZXcgPT09ICdkcmFmdHMnKSB7CiAgICAgICAgLy8gRHJhZnRzOiBvbmx5IHVzZXIncyBvd24gZHJhZnRzCiAgICAgICAgd2hlcmUuY3JlYXRlZEJ5SWQgPSB1c2VyLmlkOwogICAgICAgIHdoZXJlLnN0YXR1cyA9ICdEUkFGVCc7CiAgICAgIH0gZWxzZSBpZiAodmlldyA9PT0gJ2RlcGFydG1lbnQnICYmIGlzRGVwdEhlYWQpIHsKICAgICAgICAvLyBEZXBhcnRtZW50IHZpZXc6IG9ubHkgZGVwYXJ0bWVudCB0aWNrZXRzCiAgICAgICAgd2hlcmUuT1IgPSBbCiAgICAgICAgICB7IHRvRGVwYXJ0bWVudElkOiB1c2VyLmRlcGFydG1lbnRJZCB9LAogICAgICAgICAgeyBmcm9tRGVwYXJ0bWVudElkOiB1c2VyLmRlcGFydG1lbnRJZCB9LAogICAgICAgIF07CiAgICAgIH0gZWxzZSBpZiAodmlldyA9PT0gJ3BlcnNvbmFsJykgewogICAgICAgIC8vIFBlcnNvbmFsIHZpZXc6IG9ubHkgY3JlYXRlZCwgYXNzaWduZWQsIHdhdGNoaW5nCiAgICAgICAgd2hlcmUuT1IgPSBbCiAgICAgICAgICB7IGNyZWF0ZWRCeUlkOiB1c2VyLmlkIH0sCiAgICAgICAgICB7IGFzc2lnbmVkVG9JZDogdXNlci5pZCB9LAogICAgICAgICAgeyB3YXRjaGVyczogeyBzb21lOiB7IHVzZXJJZDogdXNlci5pZCB9IH0gfSwKICAgICAgICBdOwogICAgICB9IGVsc2UgewogICAgICAgIC8vIERlZmF1bHQ6IHBlcnNvbmFsICsgZGVwYXJ0bWVudCBmb3IgaGVhZHMKICAgICAgICBjb25zdCBvckNvbmRpdGlvbnM6IGFueVtdID0gWwogICAgICAgICAgeyBjcmVhdGVkQnlJZDogdXNlci5pZCB9LAogICAgICAgICAgeyBhc3NpZ25lZFRvSWQ6IHVzZXIuaWQgfSwKICAgICAgICAgIHsgd2F0Y2hlcnM6IHsgc29tZTogeyB1c2VySWQ6IHVzZXIuaWQgfSB9IH0sCiAgICAgICAgXTsKICAgICAgICBpZiAoaXNEZXB0SGVhZCkgewogICAgICAgICAgb3JDb25kaXRpb25zLnB1c2goeyB0b0RlcGFydG1lbnRJZDogdXNlci5kZXBhcnRtZW50SWQgfSk7CiAgICAgICAgICBvckNvbmRpdGlvbnMucHVzaCh7IGZyb21EZXBhcnRtZW50SWQ6IHVzZXIuZGVwYXJ0bWVudElkIH0pOwogICAgICAgIH0KICAgICAgICB3aGVyZS5PUiA9IG9yQ29uZGl0aW9uczsKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgLy8gQWRtaW46IGhhbmRsZSBkcmFmdHMgdmlldwogICAgICBpZiAodmlldyA9PT0gJ2RyYWZ0cycpIHsKICAgICAgICB3aGVyZS5jcmVhdGVkQnlJZCA9IHVzZXIuaWQ7CiAgICAgICAgd2hlcmUuc3RhdHVzID0gJ0RSQUZUJzsKICAgICAgfQogICAgfQoKICAgIC8vIE9ubHkgYXBwbHkgc3RhdHVzIGZpbHRlciBpZiBub3QgYWxyZWFkeSBzZXQgYnkgdmlldwogICAgaWYgKGZpbHRlcnMuc3RhdHVzICYmIHZpZXcgIT09ICdkcmFmdHMnKSB3aGVyZS5zdGF0dXMgPSBmaWx0ZXJzLnN0YXR1czsKICAgIGlmIChmaWx0ZXJzLnByaW9yaXR5KSB3aGVyZS5wcmlvcml0eSA9IGZpbHRlcnMucHJpb3JpdHk7CiAgICBpZiAoZmlsdGVycy5mcm9tRGVwYXJ0bWVudElkKSB3aGVyZS5mcm9tRGVwYXJ0bWVudElkID0gZmlsdGVycy5mcm9tRGVwYXJ0bWVudElkOwogICAgaWYgKGZpbHRlcnMudG9EZXBhcnRtZW50SWQpIHdoZXJlLnRvRGVwYXJ0bWVudElkID0gZmlsdGVycy50b0RlcGFydG1lbnRJZDsKICAgIGlmIChmaWx0ZXJzLmFzc2lnbmVkVG9JZCkgd2hlcmUuYXNzaWduZWRUb0lkID0gZmlsdGVycy5hc3NpZ25lZFRvSWQ7CiAgICBpZiAoZmlsdGVycy5jcmVhdGVkQnlJZCkgd2hlcmUuY3JlYXRlZEJ5SWQgPSBmaWx0ZXJzLmNyZWF0ZWRCeUlkOwogICAgaWYgKGZpbHRlcnMudGFncz8ubGVuZ3RoKSB3aGVyZS50YWdzID0geyBoYXNTb21lOiBmaWx0ZXJzLnRhZ3MgfTsKICAgIGlmIChmaWx0ZXJzLm92ZXJkdWUgPT09IHRydWUgfHwgZmlsdGVycy5vdmVyZHVlID09PSAndHJ1ZScpIHsKICAgICAgd2hlcmUuc2xhUmVzb2x1dGlvbkRlYWRsaW5lID0geyBsdDogbmV3IERhdGUoKSB9OwogICAgICB3aGVyZS5zdGF0dXMgPSB7IG5vdEluOiBbJ0NMT1NFRCcsICdSRUpFQ1RFRCddIH07CiAgICB9CiAgICBpZiAoZmlsdGVycy5zZWFyY2gpIHsKICAgICAgd2hlcmUuQU5EID0gWy4uLih3aGVyZS5BTkQgfHwgW10pLCB7CiAgICAgICAgT1I6IFsKICAgICAgICAgIHsgdGlja2V0TnVtYmVyOiB7IGNvbnRhaW5zOiBmaWx0ZXJzLnNlYXJjaCwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sCiAgICAgICAgICB7IHRpdGxlOiB7IGNvbnRhaW5zOiBmaWx0ZXJzLnNlYXJjaCwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sCiAgICAgICAgICB7IGRlc2NyaXB0aW9uOiB7IGNvbnRhaW5zOiBmaWx0ZXJzLnNlYXJjaCwgbW9kZTogJ2luc2Vuc2l0aXZlJyB9IH0sCiAgICAgICAgXSwKICAgICAgfV07CiAgICB9CgogICAgY29uc3QgW3RpY2tldHMsIHRvdGFsXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgdGhpcy5wcmlzbWEudGlja2V0LmZpbmRNYW55KHsKICAgICAgICB3aGVyZSwKICAgICAgICBpbmNsdWRlOiB7CiAgICAgICAgICBmcm9tRGVwYXJ0bWVudDogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIHNsdWc6IHRydWUsIGNvbG9yOiB0cnVlIH0gfSwKICAgICAgICAgIHRvRGVwYXJ0bWVudDogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIHNsdWc6IHRydWUsIGNvbG9yOiB0cnVlIH0gfSwKICAgICAgICAgIGNyZWF0ZWRCeTogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlLCBhdmF0YXI6IHRydWUgfSB9LAogICAgICAgICAgYXNzaWduZWRUbzogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlLCBhdmF0YXI6IHRydWUgfSB9LAogICAgICAgICAgc3VidHlwZTogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIG5hbWU6IHRydWUsIGNhdGVnb3J5OiB7IHNlbGVjdDogeyBpZDogdHJ1ZSwgbmFtZTogdHJ1ZSB9IH0gfSB9LAogICAgICAgICAgX2NvdW50OiB7IHNlbGVjdDogeyBtZXNzYWdlczogdHJ1ZSwgYXR0YWNobWVudHM6IHRydWUsIHdhdGNoZXJzOiB0cnVlIH0gfSwKICAgICAgICB9LAogICAgICAgIG9yZGVyQnk6IHsgW3NvcnRCeV06IHNvcnRPcmRlciB9LAogICAgICAgIHNraXA6IChwYWdlIC0gMSkgKiBsaW1pdCwKICAgICAgICB0YWtlOiBsaW1pdCwKICAgICAgfSksCiAgICAgIHRoaXMucHJpc21hLnRpY2tldC5jb3VudCh7IHdoZXJlIH0pLAogICAgXSk7CgogICAgcmV0dXJuIHsgZGF0YTogdGlja2V0cywgdG90YWwsIHBhZ2UsIGxpbWl0LCB0b3RhbFBhZ2VzOiBNYXRoLmNlaWwodG90YWwgLyBsaW1pdCkgfTsKICB9CgogIGFzeW5jIGZpbmRCeUlkKGlkOiBzdHJpbmcsIHVzZXI6IGFueSkgewogICAgY29uc3QgdGlja2V0ID0gYXdhaXQgdGhpcy5wcmlzbWEudGlja2V0LmZpbmRGaXJzdCh7CiAgICAgIHdoZXJlOiB7IE9SOiBbeyBpZCB9LCB7IHRpY2tldE51bWJlcjogaWQgfV0gfSwKICAgICAgaW5jbHVkZTogewogICAgICAgIGZyb21EZXBhcnRtZW50OiB0cnVlLCB0b0RlcGFydG1lbnQ6IHRydWUsCiAgICAgICAgY3JlYXRlZEJ5OiB7IHNlbGVjdDogeyBpZDogdHJ1ZSwgZmlyc3ROYW1lOiB0cnVlLCBsYXN0TmFtZTogdHJ1ZSwgZW1haWw6IHRydWUsIGF2YXRhcjogdHJ1ZSwgZGVwYXJ0bWVudElkOiB0cnVlIH0gfSwKICAgICAgICBhc3NpZ25lZFRvOiB7IHNlbGVjdDogeyBpZDogdHJ1ZSwgZmlyc3ROYW1lOiB0cnVlLCBsYXN0TmFtZTogdHJ1ZSwgZW1haWw6IHRydWUsIGF2YXRhcjogdHJ1ZSwgZGVwYXJ0bWVudElkOiB0cnVlIH0gfSwKICAgICAgICBzdWJ0eXBlOiB7IGluY2x1ZGU6IHsgY2F0ZWdvcnk6IHRydWUsIGZvcm1TY2hlbWE6IHRydWUgfSB9LAogICAgICAgIG1lc3NhZ2VzOiB7CiAgICAgICAgICB3aGVyZTogeyBpc0RlbGV0ZWQ6IGZhbHNlIH0sCiAgICAgICAgICBpbmNsdWRlOiB7CiAgICAgICAgICAgIGF1dGhvcjogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlLCBhdmF0YXI6IHRydWUgfSB9LAogICAgICAgICAgICBhdHRhY2htZW50czogdHJ1ZSwKICAgICAgICAgIH0sCiAgICAgICAgICBvcmRlckJ5OiB7IGNyZWF0ZWRBdDogJ2FzYycgfSwKICAgICAgICB9LAogICAgICAgIGF0dGFjaG1lbnRzOiB0cnVlLAogICAgICAgIHdhdGNoZXJzOiB7IGluY2x1ZGU6IHsgdXNlcjogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGF2YXRhcjogdHJ1ZSB9IH0gfSB9LAogICAgICAgIGhpc3RvcnlMb2dzOiB7IG9yZGVyQnk6IHsgY3JlYXRlZEF0OiAnZGVzYycgfSwgdGFrZTogNTAgfSwKICAgICAgICBmb3JtU3VibWlzc2lvbjogdHJ1ZSwKICAgICAgICBkdXBsaWNhdGVPZjogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIHRpY2tldE51bWJlcjogdHJ1ZSwgdGl0bGU6IHRydWUgfSB9LAogICAgICAgIGR1cGxpY2F0ZXM6IHsgc2VsZWN0OiB7IGlkOiB0cnVlLCB0aWNrZXROdW1iZXI6IHRydWUsIHRpdGxlOiB0cnVlIH0gfSwKICAgICAgfSwKICAgIH0pOwogICAgaWYgKCF0aWNrZXQpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVGlja2V0IG5vdCBmb3VuZCcpOwogICAgdGhpcy5jaGVja0FjY2Vzcyh0aWNrZXQsIHVzZXIpOwoKICAgIGxldCBpbnRlcm5hbE5vdGVzOiBhbnlbXSA9IFtdOwogICAgaWYgKHVzZXIuZ2xvYmFsUm9sZSA9PT0gJ0dMT0JBTF9BRE1JTicgfHwgdXNlci5kZXBhcnRtZW50SWQgPT09IHRpY2tldC50b0RlcGFydG1lbnRJZCkgewogICAgICBpbnRlcm5hbE5vdGVzID0gYXdhaXQgdGhpcy5wcmlzbWEuaW50ZXJuYWxOb3RlLmZpbmRNYW55KHsKICAgICAgICB3aGVyZTogeyB0aWNrZXRJZDogdGlja2V0LmlkIH0sCiAgICAgICAgaW5jbHVkZTogeyBhdXRob3I6IHsgc2VsZWN0OiB7IGlkOiB0cnVlLCBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlLCBhdmF0YXI6IHRydWUgfSB9IH0sCiAgICAgICAgb3JkZXJCeTogeyBjcmVhdGVkQXQ6ICdkZXNjJyB9LAogICAgICB9KTsKICAgIH0KICAgIHJldHVybiB7IC4uLnRpY2tldCwgaW50ZXJuYWxOb3RlcyB9OwogIH0KCiAgYXN5bmMgY3JlYXRlKHVzZXI6IGFueSwgZGF0YTogYW55KSB7CiAgICBjb25zdCB0aWNrZXROdW1iZXIgPSBhd2FpdCB0aGlzLnByaXNtYS5nZXROZXh0VGlja2V0TnVtYmVyKCk7CiAgICBsZXQgc2xhUmVzcG9uc2VIb3VycyA9IDI0LCBzbGFSZXNvbHV0aW9uSG91cnMgPSA3MjsKICAgIGxldCBkZWZhdWx0UHJpb3JpdHk6IFRpY2tldFByaW9yaXR5ID0gVGlja2V0UHJpb3JpdHkuTk9STUFMOwoKICAgIGlmIChkYXRhLnN1YnR5cGVJZCkgewogICAgICBjb25zdCBzdWJ0eXBlID0gYXdhaXQgdGhpcy5wcmlzbWEucmVxdWVzdFN1YnR5cGUuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkOiBkYXRhLnN1YnR5cGVJZCB9IH0pOwogICAgICBpZiAoc3VidHlwZSkgewogICAgICAgIGlmIChzdWJ0eXBlLnNsYVJlc3BvbnNlSG91cnMpIHNsYVJlc3BvbnNlSG91cnMgPSBzdWJ0eXBlLnNsYVJlc3BvbnNlSG91cnM7CiAgICAgICAgaWYgKHN1YnR5cGUuc2xhUmVzb2x1dGlvbkhvdXJzKSBzbGFSZXNvbHV0aW9uSG91cnMgPSBzdWJ0eXBlLnNsYVJlc29sdXRpb25Ib3VyczsKICAgICAgICBkZWZhdWx0UHJpb3JpdHkgPSBzdWJ0eXBlLmRlZmF1bHRQcmlvcml0eSBhcyBUaWNrZXRQcmlvcml0eTsKICAgICAgfQogICAgfQoKICAgIGNvbnN0IHByaW9yaXR5ID0gZGF0YS5wcmlvcml0eSB8fCBkZWZhdWx0UHJpb3JpdHk7CiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpOwoKICAgIC8vIEJ1aWxkIG1ldGFkYXRhIGZyb20gZW50aXR5IHNlbGVjdGlvbgogICAgY29uc3QgbWV0YWRhdGE6IGFueSA9IHt9OwogICAgaWYgKGRhdGEuZm9ybURhdGE/Ll9lbnRpdHlUeXBlICYmIGRhdGEuZm9ybURhdGEuX2VudGl0eVR5cGUgIT09ICdub25lJykgewogICAgICBtZXRhZGF0YS5lbnRpdHlUeXBlID0gZGF0YS5mb3JtRGF0YS5fZW50aXR5VHlwZTsKICAgICAgbWV0YWRhdGEuZW50aXR5SWQgPSBkYXRhLmZvcm1EYXRhLl9lbnRpdHlJZCB8fCBudWxsOwogICAgICBtZXRhZGF0YS5lbnRpdHlOYW1lID0gZGF0YS5mb3JtRGF0YS5fZW50aXR5TmFtZSB8fCBudWxsOwogICAgfQoKICAgIGNvbnN0IHRpY2tldCA9IGF3YWl0IHRoaXMucHJpc21hLnRpY2tldC5jcmVhdGUoewogICAgICBkYXRhOiB7CiAgICAgICAgdGlja2V0TnVtYmVyLCB0aXRsZTogZGF0YS50aXRsZSwgZGVzY3JpcHRpb246IGRhdGEuZGVzY3JpcHRpb24gfHwgJycsCiAgICAgICAgc3RhdHVzOiBkYXRhLmlzRHJhZnQgPyAnRFJBRlQnIDogJ09QRU4nLCBwcmlvcml0eSwKICAgICAgICBmcm9tRGVwYXJ0bWVudElkOiB1c2VyLmRlcGFydG1lbnRJZCwgdG9EZXBhcnRtZW50SWQ6IGRhdGEudG9EZXBhcnRtZW50SWQsCiAgICAgICAgc3VidHlwZUlkOiBkYXRhLnN1YnR5cGVJZCB8fCBudWxsLAogICAgICAgIGNyZWF0ZWRCeUlkOiB1c2VyLmlkLAogICAgICAgIGFzc2lnbmVkVG9JZDogZGF0YS5hc3NpZ25lZFRvSWQgfHwgbnVsbCwKICAgICAgICBkdWVEYXRlOiBkYXRhLmR1ZURhdGUgPyBuZXcgRGF0ZShkYXRhLmR1ZURhdGUpIDogbnVsbCwKICAgICAgICB0YWdzOiBkYXRhLnRhZ3MgfHwgW10sCiAgICAgICAgbWV0YWRhdGE6IE9iamVjdC5rZXlzKG1ldGFkYXRhKS5sZW5ndGggPiAwID8gbWV0YWRhdGEgOiB1bmRlZmluZWQsCiAgICAgICAgc2xhUmVzcG9uc2VEZWFkbGluZTogbmV3IERhdGUobm93LmdldFRpbWUoKSArIHNsYVJlc3BvbnNlSG91cnMgKiAzNjAwMDAwKSwKICAgICAgICBzbGFSZXNvbHV0aW9uRGVhZGxpbmU6IG5ldyBEYXRlKG5vdy5nZXRUaW1lKCkgKyBzbGFSZXNvbHV0aW9uSG91cnMgKiAzNjAwMDAwKSwKICAgICAgfSwKICAgICAgaW5jbHVkZTogeyBmcm9tRGVwYXJ0bWVudDogdHJ1ZSwgdG9EZXBhcnRtZW50OiB0cnVlLCBjcmVhdGVkQnk6IHsgc2VsZWN0OiB7IGlkOiB0cnVlLCBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSwgYXZhdGFyOiB0cnVlIH0gfSwgYXNzaWduZWRUbzogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlLCBhdmF0YXI6IHRydWUgfSB9IH0sCiAgICB9KTsKCiAgICAvLyBTYXZlIGZvcm0gc3VibWlzc2lvbjogZnJvbSBzY2hlbWEgZmllbGRzICsgYWx3YXlzIHNhdmUgaWYgZm9ybURhdGEgaGFzIGNvbnRlbnQKICAgIGNvbnN0IGNsZWFuRm9ybURhdGEgPSB7IC4uLmRhdGEuZm9ybURhdGEgfTsKICAgIGRlbGV0ZSBjbGVhbkZvcm1EYXRhLl9lbnRpdHlUeXBlOwogICAgZGVsZXRlIGNsZWFuRm9ybURhdGEuX2VudGl0eUlkOwogICAgZGVsZXRlIGNsZWFuRm9ybURhdGEuX2VudGl0eU5hbWU7CgogICAgaWYgKGRhdGEuc3VidHlwZUlkKSB7CiAgICAgIGNvbnN0IHN1YnR5cGUgPSBhd2FpdCB0aGlzLnByaXNtYS5yZXF1ZXN0U3VidHlwZS5maW5kVW5pcXVlKHsgd2hlcmU6IHsgaWQ6IGRhdGEuc3VidHlwZUlkIH0sIGluY2x1ZGU6IHsgZm9ybVNjaGVtYTogdHJ1ZSB9IH0pOwogICAgICBpZiAoc3VidHlwZT8uZm9ybVNjaGVtYUlkICYmIE9iamVjdC5rZXlzKGNsZWFuRm9ybURhdGEpLmxlbmd0aCA+IDApIHsKICAgICAgICBhd2FpdCB0aGlzLnByaXNtYS5mb3JtU3VibWlzc2lvbi5jcmVhdGUoewogICAgICAgICAgZGF0YTogeyBmb3JtU2NoZW1hSWQ6IHN1YnR5cGUuZm9ybVNjaGVtYUlkLCB0aWNrZXRJZDogdGlja2V0LmlkLCBkYXRhOiBjbGVhbkZvcm1EYXRhLCBzY2hlbWFWZXJzaW9uOiBzdWJ0eXBlLmZvcm1TY2hlbWE/LnZlcnNpb24gfHwgMSB9LAogICAgICAgIH0pOwogICAgICB9CiAgICB9CgogICAgYXdhaXQgdGhpcy5wcmlzbWEudGlja2V0V2F0Y2hlci5jcmVhdGUoeyBkYXRhOiB7IHRpY2tldElkOiB0aWNrZXQuaWQsIHVzZXJJZDogdXNlci5pZCB9IH0pOwoKICAgIC8vIEFkZCBhZGRpdGlvbmFsIHdhdGNoZXJzIChDQykKICAgIGlmIChkYXRhLndhdGNoZXJJZHM/Lmxlbmd0aCkgewogICAgICBmb3IgKGNvbnN0IHdhdGNoZXJJZCBvZiBkYXRhLndhdGNoZXJJZHMpIHsKICAgICAgICBpZiAod2F0Y2hlcklkICE9PSB1c2VyLmlkKSB7CiAgICAgICAgICBhd2FpdCB0aGlzLnByaXNtYS50aWNrZXRXYXRjaGVyLnVwc2VydCh7CiAgICAgICAgICAgIHdoZXJlOiB7IHRpY2tldElkX3VzZXJJZDogeyB0aWNrZXRJZDogdGlja2V0LmlkLCB1c2VySWQ6IHdhdGNoZXJJZCB9IH0sCiAgICAgICAgICAgIHVwZGF0ZToge30sCiAgICAgICAgICAgIGNyZWF0ZTogeyB0aWNrZXRJZDogdGlja2V0LmlkLCB1c2VySWQ6IHdhdGNoZXJJZCB9LAogICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICB9CiAgICB9CgogICAgYXdhaXQgdGhpcy5wcmlzbWEudGlja2V0SGlzdG9yeS5jcmVhdGUoeyBkYXRhOiB7IHRpY2tldElkOiB0aWNrZXQuaWQsIGZpZWxkOiAnc3RhdHVzJywgbmV3VmFsdWU6IGRhdGEuaXNEcmFmdCA/ICdEUkFGVCcgOiAnT1BFTicsIGNoYW5nZWRCeUlkOiB1c2VyLmlkIH0gfSk7CiAgICBhd2FpdCB0aGlzLnByaXNtYS5hdWRpdExvZy5jcmVhdGUoeyBkYXRhOiB7IGFjdGlvbjogJ1RJQ0tFVF9DUkVBVEVEJywgZW50aXR5VHlwZTogJ3RpY2tldCcsIGVudGl0eUlkOiB0aWNrZXQuaWQsIHVzZXJJZDogdXNlci5pZCwgbWV0YWRhdGE6IHsgdGlja2V0TnVtYmVyLCB0aXRsZTogZGF0YS50aXRsZSB9IH0gfSk7CgogICAgLy8gTGluayB1cGxvYWRlZCBhdHRhY2htZW50cyB0byB0aGlzIHRpY2tldAogICAgaWYgKGRhdGEuYXR0YWNobWVudElkcz8ubGVuZ3RoKSB7CiAgICAgIGF3YWl0IHRoaXMuZmlsZXNTZXJ2aWNlLmxpbmtUb1RpY2tldChkYXRhLmF0dGFjaG1lbnRJZHMsIHRpY2tldC5pZCk7CiAgICB9CgogICAgLy8gT25seSBub3RpZnkgaWYgbm90IGEgZHJhZnQKICAgIGlmICghZGF0YS5pc0RyYWZ0KSB7CiAgICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9ucy5ub3RpZnlUaWNrZXRDcmVhdGVkKHRpY2tldCk7CiAgICB9CiAgICByZXR1cm4gdGlja2V0OwogIH0KCiAgYXN5bmMgdXBkYXRlKGlkOiBzdHJpbmcsIHVzZXI6IGFueSwgZGF0YTogYW55KSB7CiAgICBjb25zdCB0aWNrZXQgPSBhd2FpdCB0aGlzLnByaXNtYS50aWNrZXQuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkIH0gfSk7CiAgICBpZiAoIXRpY2tldCkgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdUaWNrZXQgbm90IGZvdW5kJyk7CgogICAgY29uc3QgY2hhbmdlczogeyB0aWNrZXRJZDogc3RyaW5nOyBmaWVsZDogc3RyaW5nOyBvbGRWYWx1ZTogc3RyaW5nOyBuZXdWYWx1ZTogc3RyaW5nOyBjaGFuZ2VkQnlJZDogc3RyaW5nIH1bXSA9IFtdOwogICAgY29uc3QgdXBkYXRlRGF0YTogYW55ID0ge307CiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhkYXRhKSkgewogICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCAmJiAodGlja2V0IGFzIGFueSlba2V5XSAhPT0gdmFsdWUpIHsKICAgICAgICBjaGFuZ2VzLnB1c2goeyB0aWNrZXRJZDogaWQsIGZpZWxkOiBrZXksIG9sZFZhbHVlOiBTdHJpbmcoKHRpY2tldCBhcyBhbnkpW2tleV0gPz8gJycpLCBuZXdWYWx1ZTogU3RyaW5nKHZhbHVlKSwgY2hhbmdlZEJ5SWQ6IHVzZXIuaWQgfSk7CiAgICAgICAgdXBkYXRlRGF0YVtrZXldID0ga2V5ID09PSAnZHVlRGF0ZScgPyBuZXcgRGF0ZSh2YWx1ZSBhcyBzdHJpbmcpIDogdmFsdWU7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZGF0YS5zdGF0dXMgPT09ICdXQUlUSU5HX1JFUExZJyAmJiB0aWNrZXQuc3RhdHVzICE9PSAnV0FJVElOR19SRVBMWScpIHsKICAgICAgdXBkYXRlRGF0YS5zbGFQYXVzZWRBdCA9IG5ldyBEYXRlKCk7CiAgICB9IGVsc2UgaWYgKGRhdGEuc3RhdHVzICYmIGRhdGEuc3RhdHVzICE9PSAnV0FJVElOR19SRVBMWScgJiYgdGlja2V0LnNsYVBhdXNlZEF0KSB7CiAgICAgIGNvbnN0IHBhdXNlZFNlYyA9IE1hdGguZmxvb3IoKERhdGUubm93KCkgLSB0aWNrZXQuc2xhUGF1c2VkQXQuZ2V0VGltZSgpKSAvIDEwMDApOwogICAgICB1cGRhdGVEYXRhLnNsYVBhdXNlZER1cmF0aW9uID0gdGlja2V0LnNsYVBhdXNlZER1cmF0aW9uICsgcGF1c2VkU2VjOwogICAgICB1cGRhdGVEYXRhLnNsYVBhdXNlZEF0ID0gbnVsbDsKICAgICAgaWYgKHRpY2tldC5zbGFSZXNwb25zZURlYWRsaW5lKSB1cGRhdGVEYXRhLnNsYVJlc3BvbnNlRGVhZGxpbmUgPSBuZXcgRGF0ZSh0aWNrZXQuc2xhUmVzcG9uc2VEZWFkbGluZS5nZXRUaW1lKCkgKyBwYXVzZWRTZWMgKiAxMDAwKTsKICAgICAgaWYgKHRpY2tldC5zbGFSZXNvbHV0aW9uRGVhZGxpbmUpIHVwZGF0ZURhdGEuc2xhUmVzb2x1dGlvbkRlYWRsaW5lID0gbmV3IERhdGUodGlja2V0LnNsYVJlc29sdXRpb25EZWFkbGluZS5nZXRUaW1lKCkgKyBwYXVzZWRTZWMgKiAxMDAwKTsKICAgIH0KICAgIGlmIChkYXRhLnN0YXR1cyA9PT0gJ0NMT1NFRCcpIHsgdXBkYXRlRGF0YS5jbG9zZWRBdCA9IG5ldyBEYXRlKCk7IHVwZGF0ZURhdGEuc2xhUmVzb2x2ZWRBdCA9IG5ldyBEYXRlKCk7IH0KICAgIGlmIChkYXRhLnN0YXR1cyA9PT0gJ0lOX1BST0dSRVNTJyAmJiAhdGlja2V0LnNsYVJlc3BvbnNlQXQpIHsgdXBkYXRlRGF0YS5zbGFSZXNwb25zZUF0ID0gbmV3IERhdGUoKTsgfQoKICAgIGNvbnN0IHVwZGF0ZWQgPSBhd2FpdCB0aGlzLnByaXNtYS50aWNrZXQudXBkYXRlKHsKICAgICAgd2hlcmU6IHsgaWQgfSwgZGF0YTogdXBkYXRlRGF0YSwKICAgICAgaW5jbHVkZTogeyBmcm9tRGVwYXJ0bWVudDogdHJ1ZSwgdG9EZXBhcnRtZW50OiB0cnVlLCBjcmVhdGVkQnk6IHsgc2VsZWN0OiB7IGlkOiB0cnVlLCBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9IH0sIGFzc2lnbmVkVG86IHsgc2VsZWN0OiB7IGlkOiB0cnVlLCBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlLCBlbWFpbDogdHJ1ZSB9IH0gfSwKICAgIH0pOwoKICAgIGlmIChjaGFuZ2VzLmxlbmd0aCkgYXdhaXQgdGhpcy5wcmlzbWEudGlja2V0SGlzdG9yeS5jcmVhdGVNYW55KHsgZGF0YTogY2hhbmdlcyB9KTsKICAgIGlmIChkYXRhLnN0YXR1cyAmJiBkYXRhLnN0YXR1cyAhPT0gdGlja2V0LnN0YXR1cykgewogICAgICBhd2FpdCB0aGlzLnByaXNtYS5hdWRpdExvZy5jcmVhdGUoeyBkYXRhOiB7IGFjdGlvbjogJ1RJQ0tFVF9TVEFUVVNfQ0hBTkdFRCcsIGVudGl0eVR5cGU6ICd0aWNrZXQnLCBlbnRpdHlJZDogaWQsIHVzZXJJZDogdXNlci5pZCwgbWV0YWRhdGE6IHsgZnJvbTogdGlja2V0LnN0YXR1cywgdG86IGRhdGEuc3RhdHVzIH0gfSB9KTsKICAgICAgYXdhaXQgdGhpcy5ub3RpZmljYXRpb25zLm5vdGlmeVN0YXR1c0NoYW5nZWQodXBkYXRlZCwgdGlja2V0LnN0YXR1cywgZGF0YS5zdGF0dXMpOwogICAgfQogICAgaWYgKGRhdGEuYXNzaWduZWRUb0lkICYmIGRhdGEuYXNzaWduZWRUb0lkICE9PSB0aWNrZXQuYXNzaWduZWRUb0lkKSB7CiAgICAgIGF3YWl0IHRoaXMucHJpc21hLmF1ZGl0TG9nLmNyZWF0ZSh7IGRhdGE6IHsgYWN0aW9uOiAnVElDS0VUX0FTU0lHTkVEJywgZW50aXR5VHlwZTogJ3RpY2tldCcsIGVudGl0eUlkOiBpZCwgdXNlcklkOiB1c2VyLmlkLCBtZXRhZGF0YTogeyBhc3NpZ25lZFRvSWQ6IGRhdGEuYXNzaWduZWRUb0lkIH0gfSB9KTsKICAgICAgYXdhaXQgdGhpcy5ub3RpZmljYXRpb25zLm5vdGlmeVRpY2tldEFzc2lnbmVkKHVwZGF0ZWQpOwogICAgfQogICAgcmV0dXJuIHVwZGF0ZWQ7CiAgfQoKICBhc3luYyBhZGRNZXNzYWdlKHRpY2tldElkOiBzdHJpbmcsIHVzZXI6IGFueSwgZGF0YTogeyBjb250ZW50OiBzdHJpbmc7IG1lbnRpb25zPzogc3RyaW5nW107IGF0dGFjaG1lbnRJZHM/OiBzdHJpbmdbXSB9KSB7CiAgICBjb25zdCB0aWNrZXQgPSBhd2FpdCB0aGlzLnByaXNtYS50aWNrZXQuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkOiB0aWNrZXRJZCB9IH0pOwogICAgaWYgKCF0aWNrZXQpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbignVGlja2V0IG5vdCBmb3VuZCcpOwoKICAgIGNvbnN0IG1lc3NhZ2UgPSBhd2FpdCB0aGlzLnByaXNtYS5tZXNzYWdlLmNyZWF0ZSh7CiAgICAgIGRhdGE6IHsgdGlja2V0SWQsIGF1dGhvcklkOiB1c2VyLmlkLCBjb250ZW50OiBkYXRhLmNvbnRlbnQsIG1lbnRpb25zOiBkYXRhLm1lbnRpb25zIHx8IFtdIH0sCiAgICAgIGluY2x1ZGU6IHsgYXV0aG9yOiB7IHNlbGVjdDogeyBpZDogdHJ1ZSwgZmlyc3ROYW1lOiB0cnVlLCBsYXN0TmFtZTogdHJ1ZSwgZW1haWw6IHRydWUsIGF2YXRhcjogdHJ1ZSB9IH0sIGF0dGFjaG1lbnRzOiB0cnVlIH0sCiAgICB9KTsKCiAgICAvLyBMaW5rIHVwbG9hZGVkIGF0dGFjaG1lbnRzIHRvIHRoaXMgbWVzc2FnZQogICAgaWYgKGRhdGEuYXR0YWNobWVudElkcz8ubGVuZ3RoKSB7CiAgICAgIGF3YWl0IHRoaXMuZmlsZXNTZXJ2aWNlLmxpbmtUb01lc3NhZ2UoZGF0YS5hdHRhY2htZW50SWRzLCBtZXNzYWdlLmlkKTsKICAgICAgLy8gQWxzbyBsaW5rIHRvIHRoZSB0aWNrZXQKICAgICAgYXdhaXQgdGhpcy5maWxlc1NlcnZpY2UubGlua1RvVGlja2V0KGRhdGEuYXR0YWNobWVudElkcywgdGlja2V0SWQpOwogICAgfQoKICAgIGF3YWl0IHRoaXMucHJpc21hLnRpY2tldC51cGRhdGUoeyB3aGVyZTogeyBpZDogdGlja2V0SWQgfSwgZGF0YTogeyB1cGRhdGVkQXQ6IG5ldyBEYXRlKCkgfSB9KTsKICAgIGF3YWl0IHRoaXMubm90aWZpY2F0aW9ucy5ub3RpZnlOZXdNZXNzYWdlKHRpY2tldCwgbWVzc2FnZSwgdXNlcik7CgogICAgLy8gUmUtZmV0Y2ggd2l0aCBsaW5rZWQgYXR0YWNobWVudHMKICAgIHJldHVybiB0aGlzLnByaXNtYS5tZXNzYWdlLmZpbmRVbmlxdWUoewogICAgICB3aGVyZTogeyBpZDogbWVzc2FnZS5pZCB9LAogICAgICBpbmNsdWRlOiB7IGF1dGhvcjogeyBzZWxlY3Q6IHsgaWQ6IHRydWUsIGZpcnN0TmFtZTogdHJ1ZSwgbGFzdE5hbWU6IHRydWUsIGVtYWlsOiB0cnVlLCBhdmF0YXI6IHRydWUgfSB9LCBhdHRhY2htZW50czogdHJ1ZSB9LAogICAgfSk7CiAgfQoKICBhc3luYyBlZGl0TWVzc2FnZShtZXNzYWdlSWQ6IHN0cmluZywgdXNlcjogYW55LCBjb250ZW50OiBzdHJpbmcpIHsKICAgIGNvbnN0IG1zZyA9IGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2UuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkOiBtZXNzYWdlSWQgfSB9KTsKICAgIGlmICghbXNnIHx8IG1zZy5hdXRob3JJZCAhPT0gdXNlci5pZCkgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbigpOwogICAgcmV0dXJuIHRoaXMucHJpc21hLm1lc3NhZ2UudXBkYXRlKHsgd2hlcmU6IHsgaWQ6IG1lc3NhZ2VJZCB9LCBkYXRhOiB7IGNvbnRlbnQsIGlzRWRpdGVkOiB0cnVlIH0gfSk7CiAgfQoKICBhc3luYyBkZWxldGVNZXNzYWdlKG1lc3NhZ2VJZDogc3RyaW5nLCB1c2VyOiBhbnkpIHsKICAgIGNvbnN0IG1zZyA9IGF3YWl0IHRoaXMucHJpc21hLm1lc3NhZ2UuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkOiBtZXNzYWdlSWQgfSB9KTsKICAgIGlmICghbXNnIHx8IG1zZy5hdXRob3JJZCAhPT0gdXNlci5pZCkgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbigpOwogICAgcmV0dXJuIHRoaXMucHJpc21hLm1lc3NhZ2UudXBkYXRlKHsgd2hlcmU6IHsgaWQ6IG1lc3NhZ2VJZCB9LCBkYXRhOiB7IGlzRGVsZXRlZDogdHJ1ZSB9IH0pOwogIH0KCiAgYXN5bmMgYWRkSW50ZXJuYWxOb3RlKHRpY2tldElkOiBzdHJpbmcsIHVzZXI6IGFueSwgY29udGVudDogc3RyaW5nKSB7CiAgICBjb25zdCB0aWNrZXQgPSBhd2FpdCB0aGlzLnByaXNtYS50aWNrZXQuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkOiB0aWNrZXRJZCB9IH0pOwogICAgaWYgKCF0aWNrZXQpIHRocm93IG5ldyBOb3RGb3VuZEV4Y2VwdGlvbigpOwogICAgaWYgKHVzZXIuZ2xvYmFsUm9sZSAhPT0gJ0dMT0JBTF9BRE1JTicgJiYgdXNlci5kZXBhcnRtZW50SWQgIT09IHRpY2tldC50b0RlcGFydG1lbnRJZCkgdGhyb3cgbmV3IEZvcmJpZGRlbkV4Y2VwdGlvbigpOwoKICAgIHJldHVybiB0aGlzLnByaXNtYS5pbnRlcm5hbE5vdGUuY3JlYXRlKHsKICAgICAgZGF0YTogeyB0aWNrZXRJZCwgYXV0aG9ySWQ6IHVzZXIuaWQsIGNvbnRlbnQgfSwKICAgICAgaW5jbHVkZTogeyBhdXRob3I6IHsgc2VsZWN0OiB7IGlkOiB0cnVlLCBmaXJzdE5hbWU6IHRydWUsIGxhc3ROYW1lOiB0cnVlLCBhdmF0YXI6IHRydWUgfSB9IH0sCiAgICB9KTsKICB9CgogIGFzeW5jIGFkZFdhdGNoZXIodGlja2V0SWQ6IHN0cmluZywgdXNlcklkOiBzdHJpbmcpIHsKICAgIHJldHVybiB0aGlzLnByaXNtYS50aWNrZXRXYXRjaGVyLnVwc2VydCh7CiAgICAgIHdoZXJlOiB7IHRpY2tldElkX3VzZXJJZDogeyB0aWNrZXRJZCwgdXNlcklkIH0gfSwKICAgICAgdXBkYXRlOiB7fSwKICAgICAgY3JlYXRlOiB7IHRpY2tldElkLCB1c2VySWQgfSwKICAgIH0pOwogIH0KCiAgYXN5bmMgcmVtb3ZlV2F0Y2hlcih0aWNrZXRJZDogc3RyaW5nLCB1c2VySWQ6IHN0cmluZykgewogICAgcmV0dXJuIHRoaXMucHJpc21hLnRpY2tldFdhdGNoZXIuZGVsZXRlTWFueSh7IHdoZXJlOiB7IHRpY2tldElkLCB1c2VySWQgfSB9KTsKICB9CgogIGFzeW5jIGR1cGxpY2F0ZShpZDogc3RyaW5nLCB1c2VyOiBhbnkpIHsKICAgIGNvbnN0IG9yaWdpbmFsID0gYXdhaXQgdGhpcy5wcmlzbWEudGlja2V0LmZpbmRVbmlxdWUoeyB3aGVyZTogeyBpZCB9LCBpbmNsdWRlOiB7IGZvcm1TdWJtaXNzaW9uOiB0cnVlIH0gfSk7CiAgICBpZiAoIW9yaWdpbmFsKSB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oKTsKCiAgICBjb25zdCB0aWNrZXROdW1iZXIgPSBhd2FpdCB0aGlzLnByaXNtYS5nZXROZXh0VGlja2V0TnVtYmVyKCk7CiAgICBjb25zdCBkdXAgPSBhd2FpdCB0aGlzLnByaXNtYS50aWNrZXQuY3JlYXRlKHsKICAgICAgZGF0YTogewogICAgICAgIHRpY2tldE51bWJlciwgdGl0bGU6IGBbRFVQXSAke29yaWdpbmFsLnRpdGxlfWAsIGRlc2NyaXB0aW9uOiBvcmlnaW5hbC5kZXNjcmlwdGlvbiwKICAgICAgICBzdGF0dXM6ICdPUEVOJywgcHJpb3JpdHk6IG9yaWdpbmFsLnByaW9yaXR5LAogICAgICAgIGZyb21EZXBhcnRtZW50SWQ6IG9yaWdpbmFsLmZyb21EZXBhcnRtZW50SWQsIHRvRGVwYXJ0bWVudElkOiBvcmlnaW5hbC50b0RlcGFydG1lbnRJZCwKICAgICAgICBzdWJ0eXBlSWQ6IG9yaWdpbmFsLnN1YnR5cGVJZCwgY3JlYXRlZEJ5SWQ6IHVzZXIuaWQsCiAgICAgICAgdGFnczogb3JpZ2luYWwudGFncywgZHVwbGljYXRlT2ZJZDogb3JpZ2luYWwuaWQsCiAgICAgICAgc2xhUmVzcG9uc2VEZWFkbGluZTogbmV3IERhdGUoRGF0ZS5ub3coKSArIDI0ICogMzYwMDAwMCksCiAgICAgICAgc2xhUmVzb2x1dGlvbkRlYWRsaW5lOiBuZXcgRGF0ZShEYXRlLm5vdygpICsgNzIgKiAzNjAwMDAwKSwKICAgICAgfSwKICAgIH0pOwoKICAgIGlmIChvcmlnaW5hbC5mb3JtU3VibWlzc2lvbikgewogICAgICBhd2FpdCB0aGlzLnByaXNtYS5mb3JtU3VibWlzc2lvbi5jcmVhdGUoewogICAgICAgIGRhdGE6IHsgZm9ybVNjaGVtYUlkOiBvcmlnaW5hbC5mb3JtU3VibWlzc2lvbi5mb3JtU2NoZW1hSWQsIHRpY2tldElkOiBkdXAuaWQsIGRhdGE6IG9yaWdpbmFsLmZvcm1TdWJtaXNzaW9uLmRhdGEgYXMgYW55IH0sCiAgICAgIH0pOwogICAgfQoKICAgIGF3YWl0IHRoaXMucHJpc21hLmF1ZGl0TG9nLmNyZWF0ZSh7IGRhdGE6IHsgYWN0aW9uOiAnVElDS0VUX0RVUExJQ0FURUQnLCBlbnRpdHlUeXBlOiAndGlja2V0JywgZW50aXR5SWQ6IGR1cC5pZCwgdXNlcklkOiB1c2VyLmlkLCBtZXRhZGF0YTogeyBvcmlnaW5hbElkOiBpZCB9IH0gfSk7CiAgICByZXR1cm4gZHVwOwogIH0KCiAgYXN5bmMgZXhlY3V0ZUFjdGlvbih0aWNrZXRJZDogc3RyaW5nLCB1c2VyOiBhbnksIGFjdGlvbjogc3RyaW5nKSB7CiAgICBjb25zdCB0aWNrZXQgPSBhd2FpdCB0aGlzLnByaXNtYS50aWNrZXQuZmluZFVuaXF1ZSh7IHdoZXJlOiB7IGlkOiB0aWNrZXRJZCB9LCBpbmNsdWRlOiB7IHN1YnR5cGU6IHRydWUgfSB9KTsKICAgIGlmICghdGlja2V0KSB0aHJvdyBuZXcgTm90Rm91bmRFeGNlcHRpb24oKTsKCiAgICBjb25zdCBhY3Rpb25zID0gKHRpY2tldC5zdWJ0eXBlPy5hY3Rpb25zIGFzIGFueSkgfHwge307CiAgICBjb25zdCBhY3Rpb25EZWYgPSBhY3Rpb25zW2FjdGlvbl07CiAgICBpZiAoIWFjdGlvbkRlZikgdGhyb3cgbmV3IE5vdEZvdW5kRXhjZXB0aW9uKCdBY3Rpb24gbm90IGZvdW5kJyk7CgogICAgY29uc3QgdXBkYXRlRGF0YTogYW55ID0ge307CiAgICBpZiAoYWN0aW9uRGVmLnNldFN0YXR1cykgdXBkYXRlRGF0YS5zdGF0dXMgPSBhY3Rpb25EZWYuc2V0U3RhdHVzOwogICAgaWYgKGFjdGlvbkRlZi5zZXRTdGF0dXMgPT09ICdDTE9TRUQnKSB1cGRhdGVEYXRhLmNsb3NlZEF0ID0gbmV3IERhdGUoKTsKCiAgICBjb25zdCB1cGRhdGVkID0gYXdhaXQgdGhpcy5wcmlzbWEudGlja2V0LnVwZGF0ZSh7IHdoZXJlOiB7IGlkOiB0aWNrZXRJZCB9LCBkYXRhOiB1cGRhdGVEYXRhIH0pOwogICAgYXdhaXQgdGhpcy5wcmlzbWEudGlja2V0SGlzdG9yeS5jcmVhdGUoeyBkYXRhOiB7IHRpY2tldElkLCBmaWVsZDogJ2FjdGlvbicsIG5ld1ZhbHVlOiBhY3Rpb24sIGNoYW5nZWRCeUlkOiB1c2VyLmlkIH0gfSk7CiAgICBhd2FpdCB0aGlzLnByaXNtYS5hdWRpdExvZy5jcmVhdGUoeyBkYXRhOiB7IGFjdGlvbjogJ1RJQ0tFVF9TVEFUVVNfQ0hBTkdFRCcsIGVudGl0eVR5cGU6ICd0aWNrZXQnLCBlbnRpdHlJZDogdGlja2V0SWQsIHVzZXJJZDogdXNlci5pZCwgbWV0YWRhdGE6IHsgYWN0aW9uLCAuLi51cGRhdGVEYXRhIH0gfSB9KTsKICAgIHJldHVybiB1cGRhdGVkOwogIH0KCiAgYXN5bmMgZ2V0RGFzaGJvYXJkKHVzZXI6IGFueSkgewogICAgY29uc3QgdXNlcklkID0gdXNlci5pZDsKICAgIGNvbnN0IGRlcHRJZCA9IHVzZXIuZGVwYXJ0bWVudElkOwogICAgY29uc3QgaXNBZG1pbiA9IHVzZXIuZ2xvYmFsUm9sZSA9PT0gJ0dMT0JBTF9BRE1JTic7CiAgICBjb25zdCBpc0RlcHRIZWFkID0gdXNlci5kZXBhcnRtZW50Um9sZSA9PT0gJ0RFUEFSVE1FTlRfSEVBRCc7CgogICAgY29uc3Qgb3BlbkZpbHRlciA9IHsgc3RhdHVzOiB7IG5vdEluOiBbJ0NMT1NFRCcsICdSRUpFQ1RFRCddIGFzIGFueSB9IH07CiAgICBjb25zdCB0aWNrZXRJbmNsdWRlcyA9IHsKICAgICAgZnJvbURlcGFydG1lbnQ6IHsgc2VsZWN0OiB7IG5hbWU6IHRydWUsIGNvbG9yOiB0cnVlIH0gfSwKICAgICAgdG9EZXBhcnRtZW50OiB7IHNlbGVjdDogeyBuYW1lOiB0cnVlLCBjb2xvcjogdHJ1ZSB9IH0sCiAgICAgIGNyZWF0ZWRCeTogeyBzZWxlY3Q6IHsgZmlyc3ROYW1lOiB0cnVlLCBsYXN0TmFtZTogdHJ1ZSB9IH0sCiAgICB9OwoKICAgIC8vIC0tLS0gUGVyc29uYWwgdmlldyAoZXZlcnlvbmUgZ2V0cyB0aGlzKSAtLS0tCiAgICBjb25zdCBwZXJzb25hbEZpbHRlciA9IHsKICAgICAgT1I6IFsKICAgICAgICB7IGNyZWF0ZWRCeUlkOiB1c2VySWQgfSwKICAgICAgICB7IGFzc2lnbmVkVG9JZDogdXNlcklkIH0sCiAgICAgICAgeyB3YXRjaGVyczogeyBzb21lOiB7IHVzZXJJZCB9IH0gfSwKICAgICAgXSwKICAgIH07CgogICAgY29uc3QgW215T3BlbiwgYXNzaWduZWRUb01lLCB3YXRjaGluZ0NvdW50LCBwZXJzb25hbFJlY2VudCwgcGVyc29uYWxCeVN0YXR1cywgcGVyc29uYWxCeVByaW9yaXR5LCBwZXJzb25hbE92ZXJkdWVdID0gYXdhaXQgUHJvbWlzZS5hbGwoWwogICAgICB0aGlzLnByaXNtYS50aWNrZXQuY291bnQoeyB3aGVyZTogeyBjcmVhdGVkQnlJZDogdXNlcklkLCAuLi5vcGVuRmlsdGVyIH0gfSksCiAgICAgIHRoaXMucHJpc21hLnRpY2tldC5jb3VudCh7IHdoZXJlOiB7IGFzc2lnbmVkVG9JZDogdXNlcklkLCAuLi5vcGVuRmlsdGVyIH0gfSksCiAgICAgIHRoaXMucHJpc21hLnRpY2tldC5jb3VudCh7IHdoZXJlOiB7IHdhdGNoZXJzOiB7IHNvbWU6IHsgdXNlcklkIH0gfSwgLi4ub3BlbkZpbHRlciB9IH0pLAogICAgICB0aGlzLnByaXNtYS50aWNrZXQuZmluZE1hbnkoewogICAgICAgIHdoZXJlOiBwZXJzb25hbEZpbHRlciwgb3JkZXJCeTogeyB1cGRhdGVkQXQ6ICdkZXNjJyB9LCB0YWtlOiAxMCwgaW5jbHVkZTogdGlja2V0SW5jbHVkZXMsCiAgICAgIH0pLAogICAgICB0aGlzLnByaXNtYS50aWNrZXQuZ3JvdXBCeSh7IGJ5OiBbJ3N0YXR1cyddLCBfY291bnQ6IHRydWUsIHdoZXJlOiBwZXJzb25hbEZpbHRlciB9KSwKICAgICAgdGhpcy5wcmlzbWEudGlja2V0Lmdyb3VwQnkoeyBieTogWydwcmlvcml0eSddLCBfY291bnQ6IHRydWUsIHdoZXJlOiBwZXJzb25hbEZpbHRlciB9KSwKICAgICAgdGhpcy5wcmlzbWEudGlja2V0LmNvdW50KHsgd2hlcmU6IHsgc2xhUmVzb2x1dGlvbkRlYWRsaW5lOiB7IGx0OiBuZXcgRGF0ZSgpIH0sIC4uLm9wZW5GaWx0ZXIsIC4uLnBlcnNvbmFsRmlsdGVyIH0gfSksCiAgICBdKTsKCiAgICBjb25zdCBwZXJzb25hbCA9IHsKICAgICAgbXlPcGVuLCBhc3NpZ25lZFRvTWUsIHdhdGNoaW5nQ291bnQsIG92ZXJkdWVDb3VudDogcGVyc29uYWxPdmVyZHVlLAogICAgICByZWNlbnRseVVwZGF0ZWQ6IHBlcnNvbmFsUmVjZW50LCBieVN0YXR1czogcGVyc29uYWxCeVN0YXR1cywgYnlQcmlvcml0eTogcGVyc29uYWxCeVByaW9yaXR5LAogICAgfTsKCiAgICAvLyAtLS0tIERlcGFydG1lbnQgdmlldyAoZGVwdCBoZWFkcyAmIGFkbWlucyBvbmx5KSAtLS0tCiAgICBsZXQgZGVwYXJ0bWVudDogYW55ID0gbnVsbDsKICAgIGlmICgoaXNEZXB0SGVhZCB8fCBpc0FkbWluKSAmJiBkZXB0SWQpIHsKICAgICAgY29uc3QgZGVwdEZpbHRlciA9IGlzQWRtaW4gPyB7fSA6IHsKICAgICAgICBPUjogW3sgdG9EZXBhcnRtZW50SWQ6IGRlcHRJZCB9LCB7IGZyb21EZXBhcnRtZW50SWQ6IGRlcHRJZCB9XSwKICAgICAgfTsKCiAgICAgIGNvbnN0IFtkZXB0VG90YWwsIGRlcHRPcGVuLCBkZXB0V2FpdGluZywgZGVwdE92ZXJkdWUsIGRlcHRSZWNlbnQsIGRlcHRCeVN0YXR1cywgZGVwdEJ5UHJpb3JpdHksIGRlcHRVbmFzc2lnbmVkXSA9IGF3YWl0IFByb21pc2UuYWxsKFsKICAgICAgICB0aGlzLnByaXNtYS50aWNrZXQuY291bnQoeyB3aGVyZTogZGVwdEZpbHRlciB9KSwKICAgICAgICB0aGlzLnByaXNtYS50aWNrZXQuY291bnQoeyB3aGVyZTogeyAuLi5kZXB0RmlsdGVyLCAuLi5vcGVuRmlsdGVyIH0gfSksCiAgICAgICAgdGhpcy5wcmlzbWEudGlja2V0LmNvdW50KHsgd2hlcmU6IHsgLi4uZGVwdEZpbHRlciwgc3RhdHVzOiAnV0FJVElOR19SRVBMWScgYXMgYW55IH0gfSksCiAgICAgICAgdGhpcy5wcmlzbWEudGlja2V0LmNvdW50KHsgd2hlcmU6IHsgLi4uZGVwdEZpbHRlciwgc2xhUmVzb2x1dGlvbkRlYWRsaW5lOiB7IGx0OiBuZXcgRGF0ZSgpIH0sIC4uLm9wZW5GaWx0ZXIgfSB9KSwKICAgICAgICB0aGlzLnByaXNtYS50aWNrZXQuZmluZE1hbnkoewogICAgICAgICAgd2hlcmU6IGRlcHRGaWx0ZXIsIG9yZGVyQnk6IHsgdXBkYXRlZEF0OiAnZGVzYycgfSwgdGFrZTogMTAsIGluY2x1ZGU6IHRpY2tldEluY2x1ZGVzLAogICAgICAgIH0pLAogICAgICAgIHRoaXMucHJpc21hLnRpY2tldC5ncm91cEJ5KHsgYnk6IFsnc3RhdHVzJ10sIF9jb3VudDogdHJ1ZSwgd2hlcmU6IGRlcHRGaWx0ZXIgfSksCiAgICAgICAgdGhpcy5wcmlzbWEudGlja2V0Lmdyb3VwQnkoeyBieTogWydwcmlvcml0eSddLCBfY291bnQ6IHRydWUsIHdoZXJlOiBkZXB0RmlsdGVyIH0pLAogICAgICAgIHRoaXMucHJpc21hLnRpY2tldC5jb3VudCh7IHdoZXJlOiB7IC4uLmRlcHRGaWx0ZXIsIGFzc2lnbmVkVG9JZDogbnVsbCwgLi4ub3BlbkZpbHRlciB9IH0pLAogICAgICBdKTsKCiAgICAgIGRlcGFydG1lbnQgPSB7CiAgICAgICAgdG90YWxUaWNrZXRzOiBkZXB0VG90YWwsIG9wZW5UaWNrZXRzOiBkZXB0T3Blbiwgd2FpdGluZ1JlcGx5OiBkZXB0V2FpdGluZywKICAgICAgICBvdmVyZHVlQ291bnQ6IGRlcHRPdmVyZHVlLCB1bmFzc2lnbmVkOiBkZXB0VW5hc3NpZ25lZCwKICAgICAgICByZWNlbnRseVVwZGF0ZWQ6IGRlcHRSZWNlbnQsIGJ5U3RhdHVzOiBkZXB0QnlTdGF0dXMsIGJ5UHJpb3JpdHk6IGRlcHRCeVByaW9yaXR5LAogICAgICB9OwogICAgfQoKICAgIHJldHVybiB7IHBlcnNvbmFsLCBkZXBhcnRtZW50LCBpc0RlcHRIZWFkOiBpc0RlcHRIZWFkIHx8IGlzQWRtaW4gfTsKICB9Cn0K' | base64 -d > backend/src/modules/tickets/tickets.service.ts

echo ""
echo "Verifying..."
grep -q "hasDeptView" frontend/src/app/dashboard/page.tsx && echo " Dashboard page OK" || echo " Dashboard FAILED"
grep -q "showToggle" frontend/src/app/dashboard/tickets/page.tsx && echo " Tickets page OK" || echo " Tickets FAILED"  
grep -q "view === .drafts" backend/src/modules/tickets/tickets.service.ts && echo " Service OK" || echo " Service FAILED"

echo ""
echo "Now run:"
echo "  rm -rf frontend/.next"
echo "  cd frontend && npm run dev &"
echo "  cd backend && npm run start:dev"
